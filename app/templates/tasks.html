<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - Cloud189 自动转存</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- 头部导航 -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">📋</span>
                    <h1>任务管理</h1>
                </div>
                <nav class="nav-menu">
                    <a href="{{ url_for('index') }}" class="nav-link">🏠 首页</a>
                    <a href="{{ url_for('settings') }}" class="nav-link">⚙️ 设置</a>
                    <a href="{{ url_for('users') }}" class="nav-link">👥 用户管理</a>
                    <a href="{{ url_for('account_directories') }}" class="nav-link">📁 账号目录映射</a>
                    <a href="{{ url_for('tasks') }}" class="nav-link active">📋 任务管理</a>
                    <div class="user-menu">
                        <span class="username">{{ session.username }}</span>
                        <div class="dropdown">
                            <button class="dropdown-toggle">▼</button>
                            <div class="dropdown-menu">
                                <a href="{{ url_for('logout') }}" class="dropdown-item">🚪 退出登录</a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- 主要内容 -->
        <main class="main-content">
            <!-- 页面标题 -->
            <div class="page-header">
                <h2>📋 任务管理</h2>
                <p>管理 Cloud189 自动转存任务，查看任务状态，删除不需要的任务</p>
            </div>

            <!-- 消息提示 -->
            <div id="messageContainer" class="message-container" style="display: none;">
                <div class="message" id="message">
                    <span class="message-icon" id="messageIcon">ℹ️</span>
                    <span class="message-text" id="messageText"></span>
                </div>
            </div>

            <!-- 筛选和搜索 -->
            <div class="filter-section">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="statusFilter">状态筛选:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">全部状态</option>
                            <option value="pending">等待中</option>
                            <option value="processing">追剧中</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchInput">搜索:</label>
                        <input type="text" id="searchInput" class="search-input" placeholder="搜索任务名称、备注或账号...">
                    </div>
                    <button id="refreshBtn" class="btn btn-primary">🔄 刷新</button>
                </div>
            </div>

            <!-- 批量操作 -->
            <div class="batch-actions" style="display: none;">
                <div class="batch-info">
                    <span id="selectedCount">已选择 0 个任务</span>
                </div>
                <div class="batch-buttons">
                    <button id="selectAllBtn" class="btn btn-secondary">全选</button>
                    <button id="deselectAllBtn" class="btn btn-secondary">取消全选</button>
                    <button id="batchDeleteBtn" class="btn btn-danger">🗑️ 批量删除</button>
                </div>
            </div>

            <!-- 任务列表 -->
            <div class="tasks-container">
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner"></div>
                    <span>加载中...</span>
                </div>
                
                <div id="tasksList" class="tasks-list" style="display: none;">
                    <!-- 任务卡片将在这里动态加载 -->
                </div>
                
                <div id="noTasksMessage" class="no-tasks-message" style="display: none;">
                    <div class="empty-state">
                        <span class="empty-icon">📭</span>
                        <h3>暂无任务</h3>
                        <p>当前没有找到任何任务，或者筛选条件过于严格</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 删除确认模态框 -->
    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🗑️ 确认删除</h3>
                <button type="button" onclick="hideDeleteModal()" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">确定要删除选中的任务吗？</p>
                <div class="delete-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="deleteCloudCheckbox">
                        <span class="checkmark"></span>
                        <span class="option-text">同时删除云盘中的文件</span>
                    </label>
                </div>
                <div class="delete-warning">
                    <p>⚠️ 警告：删除操作不可恢复，请谨慎操作！</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTasks = [];
        let selectedTaskIds = [];
        let currentFilters = {
            status: 'all',
            search: ''
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 状态筛选
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentFilters.status = this.value;
                loadTasks();
            });

            // 搜索输入
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentFilters.search = this.value;
                    loadTasks();
                }, 500);
            });

            // 刷新按钮
            document.getElementById('refreshBtn').addEventListener('click', loadTasks);

            // 批量操作按钮
            document.getElementById('selectAllBtn').addEventListener('click', selectAllTasks);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllTasks);
            document.getElementById('batchDeleteBtn').addEventListener('click', showBatchDeleteModal);
        }

        // 加载任务列表
        async function loadTasks() {
            showLoading(true);
            
            try {
                const params = new URLSearchParams();
                if (currentFilters.status !== 'all') {
                    params.append('status', currentFilters.status);
                }
                if (currentFilters.search) {
                    params.append('search', currentFilters.search);
                }

                const response = await fetch(`/api/tasks?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    currentTasks = data.data || [];
                    renderTasks();
                } else {
                    showMessage(data.error || '加载任务失败', 'error');
                }
            } catch (error) {
                console.error('加载任务失败:', error);
                showMessage('加载任务失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 渲染任务列表
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const noTasksMessage = document.getElementById('noTasksMessage');

            if (currentTasks.length === 0) {
                tasksList.style.display = 'none';
                noTasksMessage.style.display = 'block';
                return;
            }

            tasksList.style.display = 'block';
            noTasksMessage.style.display = 'none';

            tasksList.innerHTML = currentTasks.map(task => `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-checkbox">
                            <label class="checkbox-label">
                                <input type="checkbox" class="task-select-checkbox" value="${task.id}">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="task-status">
                            <span class="status-badge status-${task.status}">${getStatusText(task.status)}</span>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">
                                🗑️ 删除
                            </button>
                        </div>
                    </div>
                    <div class="task-content">
                        <div class="task-info">
                            <div class="task-name">
                                <strong>${task.resourceName || '未知资源'}</strong>
                                ${task.shareFolderName ? `<span class="sub-folder">/ ${task.shareFolderName}</span>` : ''}
                            </div>
                            <div class="task-details">
                                <span class="detail-item">
                                    <span class="detail-label">账号:</span>
                                    <span class="detail-value">${task.account?.username || '未知'}</span>
                                </span>
                                <span class="detail-item">
                                    <span class="detail-label">保存目录:</span>
                                    <span class="detail-value">${task.realFolderName || '未知'}</span>
                                </span>
                                <span class="detail-item">
                                    <span class="detail-label">创建时间:</span>
                                    <span class="detail-value">${formatDate(task.createdAt)}</span>
                                </span>
                            </div>
                            ${task.remark ? `
                                <div class="task-remark">
                                    <span class="remark-label">备注:</span>
                                    <span class="remark-text">${task.remark}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="task-progress">
                            ${task.totalEpisodes > 0 ? `
                                <div class="progress-info">
                                    <span class="progress-text">进度: ${task.currentEpisodes || 0} / ${task.totalEpisodes}</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${((task.currentEpisodes || 0) / task.totalEpisodes * 100)}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // 绑定复选框事件
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchActions);
            });
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'pending': '等待中',
                'processing': '追剧中',
                'completed': '已完成',
                'failed': '失败'
            };
            return statusMap[status] || status;
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未知';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // 更新批量操作状态
        function updateBatchActions() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            selectedTaskIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const batchActions = document.querySelector('.batch-actions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedTaskIds.length > 0) {
                batchActions.style.display = 'flex';
                selectedCount.textContent = `已选择 ${selectedTaskIds.length} 个任务`;
            } else {
                batchActions.style.display = 'none';
            }
        }

        // 全选任务
        function selectAllTasks() {
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateBatchActions();
        }

        // 取消全选
        function deselectAllTasks() {
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBatchActions();
        }

        // 删除单个任务
        async function deleteTask(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            const taskName = task.resourceName || '未知任务';
            document.getElementById('deleteMessage').textContent = `确定要删除任务 "${taskName}" 吗？`;
            
            showDeleteModal(taskId);
        }

        // 显示批量删除模态框
        function showBatchDeleteModal() {
            document.getElementById('deleteMessage').textContent = `确定要删除选中的 ${selectedTaskIds.length} 个任务吗？`;
            showDeleteModal(null);
        }

        // 显示删除确认模态框
        function showDeleteModal(taskId) {
            document.getElementById('deleteModal').style.display = 'flex';
            document.getElementById('deleteModal').dataset.taskId = taskId || '';
        }

        // 隐藏删除确认模态框
        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('deleteCloudCheckbox').checked = false;
        }

        // 确认删除
        async function confirmDelete() {
            const taskId = document.getElementById('deleteModal').dataset.taskId;
            const deleteCloud = document.getElementById('deleteCloudCheckbox').checked;
            
            try {
                if (taskId) {
                    // 删除单个任务
                    await deleteSingleTask(parseInt(taskId), deleteCloud);
                } else {
                    // 批量删除任务
                    await deleteBatchTasks(deleteCloud);
                }
                
                hideDeleteModal();
                loadTasks();
            } catch (error) {
                console.error('删除失败:', error);
                showMessage('删除失败: ' + error.message, 'error');
            }
        }

        // 删除单个任务
        async function deleteSingleTask(taskId, deleteCloud) {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ deleteCloud })
            });

            const data = await response.json();
            if (data.success) {
                showMessage('任务删除成功', 'success');
            } else {
                throw new Error(data.error || '删除失败');
            }
        }

        // 批量删除任务
        async function deleteBatchTasks(deleteCloud) {
            const response = await fetch('/api/tasks/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskIds: selectedTaskIds,
                    deleteCloud
                })
            });

            const data = await response.json();
            if (data.success) {
                showMessage(`成功删除 ${selectedTaskIds.length} 个任务`, 'success');
                selectedTaskIds = [];
                updateBatchActions();
            } else {
                throw new Error(data.error || '批量删除失败');
            }
        }

        // 显示加载状态
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tasksList = document.getElementById('tasksList');
            const noTasksMessage = document.getElementById('noTasksMessage');
            
            if (show) {
                loadingIndicator.style.display = 'flex';
                tasksList.style.display = 'none';
                noTasksMessage.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }

        // 显示消息
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.getElementById('message');
            const messageIcon = document.getElementById('messageIcon');
            const messageText = document.getElementById('messageText');

            messageElement.className = `message ${type}`;
            messageIcon.textContent = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            messageText.textContent = message;

            messageContainer.style.display = 'block';

            // 3秒后自动隐藏
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html> 