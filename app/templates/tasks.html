<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç† - Cloud189 è‡ªåŠ¨è½¬å­˜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title">â˜ï¸ äº‘ç›˜è‡ªåŠ¨ä¿å­˜</h1>
                    <p class="app-subtitle">æ™ºèƒ½äº‘ç›˜æ–‡ä»¶è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ</p>
                </div>
                <div class="header-right">
                    {% if session.username %}
                        <div class="user-menu">
                            <span class="user-info">
                                ğŸ‘¤ {{ session.username }}
                                {% if session.is_admin %}<span class="admin-badge">ğŸ‘‘</span>{% endif %}
                            </span>
                            <div class="user-dropdown">
                                {% if session.is_admin %}
                                <a href="{{ url_for('settings') }}" class="dropdown-item">
                                    âš™ï¸ ç³»ç»Ÿè®¾ç½®
                                </a>
                                <a href="{{ url_for('users') }}" class="dropdown-item">
                                    ğŸ‘¥ ç”¨æˆ·ç®¡ç†
                                </a>
                                <a href="{{ url_for('account_directories') }}" class="dropdown-item">
                                    ğŸ“ è´¦å·ç›®å½•æ˜ å°„
                                </a>
                                <a href="{{ url_for('tasks') }}" class="dropdown-item">
                                    ğŸ“‹ ä»»åŠ¡ç®¡ç†
                                </a>
                                <a href="{{ url_for('auto_delete_config') }}" class="dropdown-item">
                                    ğŸ—‘ï¸ è‡ªåŠ¨åˆ é™¤é…ç½®
                                </a>
                                {% endif %}
                                <a href="{{ url_for('logout') }}" class="dropdown-item">
                                    ğŸšª é€€å‡ºç™»å½•
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="auth-buttons">
                            <a href="{{ url_for('login') }}" class="btn btn-secondary">
                                ğŸ” ç™»å½•
                            </a>
                            <a href="{{ url_for('register') }}" class="btn btn-primary">
                                ğŸ“ æ³¨å†Œ
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="main-content">
            <!-- é¡µé¢æ ‡é¢˜å’Œç»Ÿè®¡ -->
            <div class="page-header">
                <div class="header-content">
                    <div class="header-left">
                        <h2>ğŸ“‹ ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ</h2>
                        <p>ç®¡ç† Cloud189 è‡ªåŠ¨è½¬å­˜ä»»åŠ¡ï¼Œå®æ—¶ç›‘æ§ä»»åŠ¡çŠ¶æ€ï¼Œé«˜æ•ˆç®¡ç†æ‚¨çš„è½¬å­˜ä»»åŠ¡</p>
                    </div>
                    <div class="header-actions">
                        <button id="refreshBtn" class="btn btn-primary">
                            <span class="btn-icon">ğŸ”„</span>
                            <span class="btn-text">åˆ·æ–°</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div id="messageContainer" class="message-container" style="display: none;">
                <div class="message" id="message">
                    <span class="message-icon" id="messageIcon">â„¹ï¸</span>
                    <span class="message-text" id="messageText"></span>
                </div>
            </div>

            <!-- ä»»åŠ¡ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon pending">â³</div>
                        <div class="stat-content">
                            <div class="stat-number" id="pendingCount">0</div>
                            <div class="stat-label">ç­‰å¾…ä¸­</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon processing">ğŸ“º</div>
                        <div class="stat-content">
                            <div class="stat-number" id="processingCount">0</div>
                            <div class="stat-label">è¿½å‰§ä¸­</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon completed">âœ…</div>
                        <div class="stat-content">
                            <div class="stat-number" id="completedCount">0</div>
                            <div class="stat-label">å·²å®Œæˆ</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon failed">âŒ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="failedCount">0</div>
                            <div class="stat-label">å¤±è´¥</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="filter-section">
                <div class="filter-header">
                    <h3>ğŸ” ç­›é€‰ä¸æœç´¢</h3>
                </div>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="statusFilter">çŠ¶æ€ç­›é€‰</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">ç­‰å¾…ä¸­</option>
                            <option value="processing">è¿½å‰§ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="failed">å¤±è´¥</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchInput">å…³é”®è¯æœç´¢</label>
                        <div class="search-input-group">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ä»»åŠ¡åç§°ã€å¤‡æ³¨æˆ–è´¦å·...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="batch-actions" style="display: none;">
                <div class="batch-header">
                    <div class="batch-info">
                        <span class="batch-icon">ğŸ“¦</span>
                        <span id="selectedCount">å·²é€‰æ‹© 0 ä¸ªä»»åŠ¡</span>
                    </div>
                    <div class="batch-buttons">
                        <button id="selectAllBtn" class="btn btn-secondary">
                            <span class="btn-icon">â˜‘ï¸</span>
                            <span class="btn-text">å…¨é€‰</span>
                        </button>
                        <button id="deselectAllBtn" class="btn btn-secondary">
                            <span class="btn-icon">â˜</span>
                            <span class="btn-text">å–æ¶ˆå…¨é€‰</span>
                        </button>
                        <button id="batchDeleteBtn" class="btn btn-danger">
                            <span class="btn-icon">ğŸ—‘ï¸</span>
                            <span class="btn-text">æ‰¹é‡åˆ é™¤</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="tasks-container">
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">
                        <h3>åŠ è½½ä¸­...</h3>
                        <p>æ­£åœ¨è·å–ä»»åŠ¡åˆ—è¡¨ï¼Œè¯·ç¨å€™</p>
                    </div>
                </div>
                
                <div id="tasksList" class="tasks-list" style="display: none;">
                    <!-- ä»»åŠ¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
                
                <div id="noTasksMessage" class="no-tasks-message" style="display: none;">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <h3>æš‚æ— ä»»åŠ¡</h3>
                        <p>å½“å‰æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä»»åŠ¡ï¼Œæˆ–è€…ç­›é€‰æ¡ä»¶è¿‡äºä¸¥æ ¼</p>
                        <button class="btn btn-primary" onclick="loadTasks()">
                            <span class="btn-icon">ğŸ”„</span>
                            <span class="btn-text">é‡æ–°åŠ è½½</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="modal-content delete-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">ğŸ—‘ï¸</span>
                    <h3>ç¡®è®¤åˆ é™¤</h3>
                </div>
                <button type="button" onclick="hideDeleteModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="delete-content">
                    <div class="delete-icon">âš ï¸</div>
                    <div class="delete-text">
                        <h4 id="deleteMessage">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ä»»åŠ¡å—ï¼Ÿ</h4>
                        <p>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ</p>
                    </div>
                </div>
                <div class="delete-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="deleteCloudCheckbox">
                        <span class="checkmark"></span>
                        <span class="option-text">åŒæ—¶åˆ é™¤äº‘ç›˜ä¸­çš„æ–‡ä»¶</span>
                    </label>
                </div>
                <div class="delete-warning">
                    <div class="warning-icon">ğŸš¨</div>
                    <div class="warning-text">
                        <strong>è­¦å‘Šï¼š</strong>åˆ é™¤äº‘ç›˜æ–‡ä»¶å°†æ°¸ä¹…åˆ é™¤ç›¸å…³æ–‡ä»¶ï¼Œæ— æ³•æ¢å¤ï¼
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">
                    <span class="btn-icon">âŒ</span>
                    <span class="btn-text">å–æ¶ˆ</span>
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                    <span class="btn-text">ç¡®è®¤åˆ é™¤</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTasks = [];
        let selectedTaskIds = [];
        let currentFilters = {
            status: 'all',
            search: ''
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // çŠ¶æ€ç­›é€‰
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentFilters.status = this.value;
                loadTasks();
            });

            // æœç´¢è¾“å…¥
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentFilters.search = this.value;
                    loadTasks();
                }, 500);
            });

            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').addEventListener('click', loadTasks);

            // æ‰¹é‡æ“ä½œæŒ‰é’®
            document.getElementById('selectAllBtn').addEventListener('click', selectAllTasks);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllTasks);
            document.getElementById('batchDeleteBtn').addEventListener('click', showBatchDeleteModal);
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            showLoading(true);
            
            try {
                const params = new URLSearchParams();
                if (currentFilters.status !== 'all') {
                    params.append('status', currentFilters.status);
                }
                if (currentFilters.search) {
                    params.append('search', currentFilters.search);
                }

                const response = await fetch(`/api/tasks?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    currentTasks = data.data || [];
                    renderTasks();
                    updateStats();
                } else {
                    showMessage(data.error || 'åŠ è½½ä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                showMessage('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const noTasksMessage = document.getElementById('noTasksMessage');

            if (currentTasks.length === 0) {
                tasksList.style.display = 'none';
                noTasksMessage.style.display = 'block';
                return;
            }

            tasksList.style.display = 'block';
            noTasksMessage.style.display = 'none';

            tasksList.innerHTML = currentTasks.map(task => `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-checkbox">
                            <label class="checkbox-label">
                                <input type="checkbox" class="task-select-checkbox" value="${task.id}">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="task-status">
                            <span class="status-badge status-${task.status}">
                                <span class="status-icon">${getStatusIcon(task.status)}</span>
                                <span class="status-text">${getStatusText(task.status)}</span>
                            </span>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                <span class="btn-text">åˆ é™¤</span>
                            </button>
                        </div>
                    </div>
                    <div class="task-content">
                        <div class="task-main">
                            <div class="task-title">
                                <div class="task-name">
                                    <span class="name-icon">ğŸ“º</span>
                                    <strong>${task.resourceName || 'æœªçŸ¥èµ„æº'}</strong>
                                    ${task.shareFolderName ? `<span class="sub-folder">/ ${task.shareFolderName}</span>` : ''}
                                </div>
                                <div class="task-meta">
                                    <span class="meta-item">
                                        <span class="meta-icon">ğŸ‘¤</span>
                                        <span class="meta-text">${task.account?.username || 'æœªçŸ¥è´¦å·'}</span>
                                    </span>
                                    <span class="meta-item">
                                        <span class="meta-icon">ğŸ“…</span>
                                        <span class="meta-text">${formatDate(task.createdAt)}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="task-details">
                                <div class="detail-row">
                                    <span class="detail-item">
                                        <span class="detail-label">ä¿å­˜ç›®å½•</span>
                                        <span class="detail-value">${task.realFolderName || 'æœªçŸ¥'}</span>
                                    </span>
                                    <span class="detail-item">
                                        <span class="detail-label">æœ€åæ£€æŸ¥</span>
                                        <span class="detail-value">${formatDate(task.lastCheckTime) || 'æœªæ£€æŸ¥'}</span>
                                    </span>
                                </div>
                                ${task.remark ? `
                                    <div class="task-remark">
                                        <span class="remark-icon">ğŸ“</span>
                                        <span class="remark-text">${task.remark}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="task-progress">
                            ${task.totalEpisodes > 0 ? `
                                <div class="progress-section">
                                    <div class="progress-header">
                                        <span class="progress-label">è½¬å­˜è¿›åº¦</span>
                                        <span class="progress-count">${task.currentEpisodes || 0} / ${task.totalEpisodes}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${((task.currentEpisodes || 0) / task.totalEpisodes * 100)}%"></div>
                                    </div>
                                    <div class="progress-percentage">${Math.round(((task.currentEpisodes || 0) / task.totalEpisodes * 100))}%</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchActions);
            });
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'processing': 'è¿½å‰§ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        // è·å–çŠ¶æ€å›¾æ ‡
        function getStatusIcon(status) {
            const iconMap = {
                'pending': 'â³',
                'processing': 'ğŸ“º',
                'completed': 'âœ…',
                'failed': 'âŒ'
            };
            return iconMap[status] || 'â“';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = {
                pending: 0,
                processing: 0,
                completed: 0,
                failed: 0
            };

            currentTasks.forEach(task => {
                if (stats.hasOwnProperty(task.status)) {
                    stats[task.status]++;
                }
            });

            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('processingCount').textContent = stats.processing;
            document.getElementById('completedCount').textContent = stats.completed;
            document.getElementById('failedCount').textContent = stats.failed;
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œçŠ¶æ€
        function updateBatchActions() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            selectedTaskIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const batchActions = document.querySelector('.batch-actions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedTaskIds.length > 0) {
                batchActions.style.display = 'flex';
                selectedCount.textContent = `å·²é€‰æ‹© ${selectedTaskIds.length} ä¸ªä»»åŠ¡`;
            } else {
                batchActions.style.display = 'none';
            }
        }

        // å…¨é€‰ä»»åŠ¡
        function selectAllTasks() {
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateBatchActions();
        }

        // å–æ¶ˆå…¨é€‰
        function deselectAllTasks() {
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBatchActions();
        }

        // åˆ é™¤å•ä¸ªä»»åŠ¡
        async function deleteTask(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            const taskName = task.resourceName || 'æœªçŸ¥ä»»åŠ¡';
            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ "${taskName}" å—ï¼Ÿ`;
            
            showDeleteModal(taskId);
        }

        // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤æ¨¡æ€æ¡†
        function showBatchDeleteModal() {
            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTaskIds.length} ä¸ªä»»åŠ¡å—ï¼Ÿ`;
            showDeleteModal(null);
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteModal(taskId) {
            document.getElementById('deleteModal').style.display = 'flex';
            document.getElementById('deleteModal').dataset.taskId = taskId || '';
        }

        // éšè—åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('deleteCloudCheckbox').checked = false;
        }

        // ç¡®è®¤åˆ é™¤
        async function confirmDelete() {
            const taskId = document.getElementById('deleteModal').dataset.taskId;
            const deleteCloud = document.getElementById('deleteCloudCheckbox').checked;
            
            try {
                if (taskId) {
                    // åˆ é™¤å•ä¸ªä»»åŠ¡
                    await deleteSingleTask(parseInt(taskId), deleteCloud);
                } else {
                    // æ‰¹é‡åˆ é™¤ä»»åŠ¡
                    await deleteBatchTasks(deleteCloud);
                }
                
                hideDeleteModal();
                loadTasks();
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤å•ä¸ªä»»åŠ¡
        async function deleteSingleTask(taskId, deleteCloud) {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ deleteCloud })
            });

            const data = await response.json();
            if (data.success) {
                showMessage('ä»»åŠ¡åˆ é™¤æˆåŠŸ', 'success');
            } else {
                throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
            }
        }

        // æ‰¹é‡åˆ é™¤ä»»åŠ¡
        async function deleteBatchTasks(deleteCloud) {
            const response = await fetch('/api/tasks/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskIds: selectedTaskIds,
                    deleteCloud
                })
            });

            const data = await response.json();
            if (data.success) {
                showMessage(`æˆåŠŸåˆ é™¤ ${selectedTaskIds.length} ä¸ªä»»åŠ¡`, 'success');
                selectedTaskIds = [];
                updateBatchActions();
            } else {
                throw new Error(data.error || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tasksList = document.getElementById('tasksList');
            const noTasksMessage = document.getElementById('noTasksMessage');
            
            if (show) {
                loadingIndicator.style.display = 'flex';
                tasksList.style.display = 'none';
                noTasksMessage.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.getElementById('message');
            const messageIcon = document.getElementById('messageIcon');
            const messageText = document.getElementById('messageText');

            messageElement.className = `message ${type}`;
            messageIcon.textContent = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            messageText.textContent = message;

            messageContainer.style.display = 'block';

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html> 