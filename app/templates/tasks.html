<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç† - Cloud189 è‡ªåŠ¨è½¬å­˜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ“‹</span>
                    <h1>ä»»åŠ¡ç®¡ç†</h1>
                </div>
                <nav class="nav-menu">
                    <a href="{{ url_for('index') }}" class="nav-link">ğŸ  é¦–é¡µ</a>
                    <a href="{{ url_for('settings') }}" class="nav-link">âš™ï¸ è®¾ç½®</a>
                    <a href="{{ url_for('users') }}" class="nav-link">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
                    <a href="{{ url_for('account_directories') }}" class="nav-link">ğŸ“ è´¦å·ç›®å½•æ˜ å°„</a>
                    <a href="{{ url_for('tasks') }}" class="nav-link active">ğŸ“‹ ä»»åŠ¡ç®¡ç†</a>
                    <div class="user-menu">
                        <span class="username">{{ session.username }}</span>
                        <div class="dropdown">
                            <button class="dropdown-toggle">â–¼</button>
                            <div class="dropdown-menu">
                                <a href="{{ url_for('logout') }}" class="dropdown-item">ğŸšª é€€å‡ºç™»å½•</a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="main-content">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="page-header">
                <h2>ğŸ“‹ ä»»åŠ¡ç®¡ç†</h2>
                <p>ç®¡ç† Cloud189 è‡ªåŠ¨è½¬å­˜ä»»åŠ¡ï¼ŒæŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ï¼Œåˆ é™¤ä¸éœ€è¦çš„ä»»åŠ¡</p>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div id="messageContainer" class="message-container" style="display: none;">
                <div class="message" id="message">
                    <span class="message-icon" id="messageIcon">â„¹ï¸</span>
                    <span class="message-text" id="messageText"></span>
                </div>
            </div>

            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="filter-section">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="statusFilter">çŠ¶æ€ç­›é€‰:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">ç­‰å¾…ä¸­</option>
                            <option value="processing">è¿½å‰§ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="failed">å¤±è´¥</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchInput">æœç´¢:</label>
                        <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ä»»åŠ¡åç§°ã€å¤‡æ³¨æˆ–è´¦å·...">
                    </div>
                    <button id="refreshBtn" class="btn btn-primary">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="batch-actions" style="display: none;">
                <div class="batch-info">
                    <span id="selectedCount">å·²é€‰æ‹© 0 ä¸ªä»»åŠ¡</span>
                </div>
                <div class="batch-buttons">
                    <button id="selectAllBtn" class="btn btn-secondary">å…¨é€‰</button>
                    <button id="deselectAllBtn" class="btn btn-secondary">å–æ¶ˆå…¨é€‰</button>
                    <button id="batchDeleteBtn" class="btn btn-danger">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="tasks-container">
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner"></div>
                    <span>åŠ è½½ä¸­...</span>
                </div>
                
                <div id="tasksList" class="tasks-list" style="display: none;">
                    <!-- ä»»åŠ¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
                
                <div id="noTasksMessage" class="no-tasks-message" style="display: none;">
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ“­</span>
                        <h3>æš‚æ— ä»»åŠ¡</h3>
                        <p>å½“å‰æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä»»åŠ¡ï¼Œæˆ–è€…ç­›é€‰æ¡ä»¶è¿‡äºä¸¥æ ¼</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤</h3>
                <button type="button" onclick="hideDeleteModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ä»»åŠ¡å—ï¼Ÿ</p>
                <div class="delete-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="deleteCloudCheckbox">
                        <span class="checkmark"></span>
                        <span class="option-text">åŒæ—¶åˆ é™¤äº‘ç›˜ä¸­çš„æ–‡ä»¶</span>
                    </label>
                </div>
                <div class="delete-warning">
                    <p>âš ï¸ è­¦å‘Šï¼šåˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTasks = [];
        let selectedTaskIds = [];
        let currentFilters = {
            status: 'all',
            search: ''
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // çŠ¶æ€ç­›é€‰
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentFilters.status = this.value;
                loadTasks();
            });

            // æœç´¢è¾“å…¥
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentFilters.search = this.value;
                    loadTasks();
                }, 500);
            });

            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').addEventListener('click', loadTasks);

            // æ‰¹é‡æ“ä½œæŒ‰é’®
            document.getElementById('selectAllBtn').addEventListener('click', selectAllTasks);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllTasks);
            document.getElementById('batchDeleteBtn').addEventListener('click', showBatchDeleteModal);
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            showLoading(true);
            
            try {
                const params = new URLSearchParams();
                if (currentFilters.status !== 'all') {
                    params.append('status', currentFilters.status);
                }
                if (currentFilters.search) {
                    params.append('search', currentFilters.search);
                }

                const response = await fetch(`/api/tasks?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    currentTasks = data.data || [];
                    renderTasks();
                } else {
                    showMessage(data.error || 'åŠ è½½ä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                showMessage('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const noTasksMessage = document.getElementById('noTasksMessage');

            if (currentTasks.length === 0) {
                tasksList.style.display = 'none';
                noTasksMessage.style.display = 'block';
                return;
            }

            tasksList.style.display = 'block';
            noTasksMessage.style.display = 'none';

            tasksList.innerHTML = currentTasks.map(task => `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-checkbox">
                            <label class="checkbox-label">
                                <input type="checkbox" class="task-select-checkbox" value="${task.id}">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="task-status">
                            <span class="status-badge status-${task.status}">${getStatusText(task.status)}</span>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div class="task-content">
                        <div class="task-info">
                            <div class="task-name">
                                <strong>${task.resourceName || 'æœªçŸ¥èµ„æº'}</strong>
                                ${task.shareFolderName ? `<span class="sub-folder">/ ${task.shareFolderName}</span>` : ''}
                            </div>
                            <div class="task-details">
                                <span class="detail-item">
                                    <span class="detail-label">è´¦å·:</span>
                                    <span class="detail-value">${task.account?.username || 'æœªçŸ¥'}</span>
                                </span>
                                <span class="detail-item">
                                    <span class="detail-label">ä¿å­˜ç›®å½•:</span>
                                    <span class="detail-value">${task.realFolderName || 'æœªçŸ¥'}</span>
                                </span>
                                <span class="detail-item">
                                    <span class="detail-label">åˆ›å»ºæ—¶é—´:</span>
                                    <span class="detail-value">${formatDate(task.createdAt)}</span>
                                </span>
                            </div>
                            ${task.remark ? `
                                <div class="task-remark">
                                    <span class="remark-label">å¤‡æ³¨:</span>
                                    <span class="remark-text">${task.remark}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="task-progress">
                            ${task.totalEpisodes > 0 ? `
                                <div class="progress-info">
                                    <span class="progress-text">è¿›åº¦: ${task.currentEpisodes || 0} / ${task.totalEpisodes}</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${((task.currentEpisodes || 0) / task.totalEpisodes * 100)}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchActions);
            });
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'processing': 'è¿½å‰§ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œçŠ¶æ€
        function updateBatchActions() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            selectedTaskIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const batchActions = document.querySelector('.batch-actions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedTaskIds.length > 0) {
                batchActions.style.display = 'flex';
                selectedCount.textContent = `å·²é€‰æ‹© ${selectedTaskIds.length} ä¸ªä»»åŠ¡`;
            } else {
                batchActions.style.display = 'none';
            }
        }

        // å…¨é€‰ä»»åŠ¡
        function selectAllTasks() {
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateBatchActions();
        }

        // å–æ¶ˆå…¨é€‰
        function deselectAllTasks() {
            document.querySelectorAll('.task-select-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBatchActions();
        }

        // åˆ é™¤å•ä¸ªä»»åŠ¡
        async function deleteTask(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            const taskName = task.resourceName || 'æœªçŸ¥ä»»åŠ¡';
            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ "${taskName}" å—ï¼Ÿ`;
            
            showDeleteModal(taskId);
        }

        // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤æ¨¡æ€æ¡†
        function showBatchDeleteModal() {
            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTaskIds.length} ä¸ªä»»åŠ¡å—ï¼Ÿ`;
            showDeleteModal(null);
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteModal(taskId) {
            document.getElementById('deleteModal').style.display = 'flex';
            document.getElementById('deleteModal').dataset.taskId = taskId || '';
        }

        // éšè—åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('deleteCloudCheckbox').checked = false;
        }

        // ç¡®è®¤åˆ é™¤
        async function confirmDelete() {
            const taskId = document.getElementById('deleteModal').dataset.taskId;
            const deleteCloud = document.getElementById('deleteCloudCheckbox').checked;
            
            try {
                if (taskId) {
                    // åˆ é™¤å•ä¸ªä»»åŠ¡
                    await deleteSingleTask(parseInt(taskId), deleteCloud);
                } else {
                    // æ‰¹é‡åˆ é™¤ä»»åŠ¡
                    await deleteBatchTasks(deleteCloud);
                }
                
                hideDeleteModal();
                loadTasks();
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤å•ä¸ªä»»åŠ¡
        async function deleteSingleTask(taskId, deleteCloud) {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ deleteCloud })
            });

            const data = await response.json();
            if (data.success) {
                showMessage('ä»»åŠ¡åˆ é™¤æˆåŠŸ', 'success');
            } else {
                throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
            }
        }

        // æ‰¹é‡åˆ é™¤ä»»åŠ¡
        async function deleteBatchTasks(deleteCloud) {
            const response = await fetch('/api/tasks/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskIds: selectedTaskIds,
                    deleteCloud
                })
            });

            const data = await response.json();
            if (data.success) {
                showMessage(`æˆåŠŸåˆ é™¤ ${selectedTaskIds.length} ä¸ªä»»åŠ¡`, 'success');
                selectedTaskIds = [];
                updateBatchActions();
            } else {
                throw new Error(data.error || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tasksList = document.getElementById('tasksList');
            const noTasksMessage = document.getElementById('noTasksMessage');
            
            if (show) {
                loadingIndicator.style.display = 'flex';
                tasksList.style.display = 'none';
                noTasksMessage.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.getElementById('message');
            const messageIcon = document.getElementById('messageIcon');
            const messageText = document.getElementById('messageText');

            messageElement.className = `message ${type}`;
            messageIcon.textContent = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            messageText.textContent = message;

            messageContainer.style.display = 'block';

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html> 