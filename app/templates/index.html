<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云盘自动保存</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航栏 -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">☁️ 云盘自动保存</h1>
                <nav class="app-nav">
                    <a href="{{ url_for('settings') }}" class="nav-link">⚙️ 设置</a>
                </nav>
            </div>
        </header>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 状态信息卡片 -->
            <div class="status-cards">
                <!-- 配置状态 -->
                <div class="status-card">
                    <div class="card-header">
                        <span class="card-icon">🔧</span>
                        <h3>配置状态</h3>
                    </div>
                    <div class="card-content">
                        {% if settings and (settings.project_address or settings.api_key) %}
                            <div class="status-item success">
                                <span class="status-icon">✅</span>
                                <span>已配置</span>
                            </div>
                            {% if settings.project_address %}
                            <div class="config-item">
                                <span class="label">项目地址:</span>
                                <span class="value">{{ settings.project_address }}</span>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="status-item error">
                                <span class="status-icon">❌</span>
                                <span>未配置</span>
                            </div>
                            <a href="{{ url_for('settings') }}" class="config-link">点击配置</a>
                        {% endif %}
                    </div>
                </div>

                <!-- 账号信息 -->
                <div class="status-card">
                    <div class="card-header">
                        <span class="card-icon">👤</span>
                        <h3>账号信息</h3>
                    </div>
                    <div class="card-content">
                        {% if accounts %}
                            {% for account in accounts %}
                            <div class="account-item">
                                <span class="account-id">#{{ account.id }}</span>
                                <span class="account-name">{{ account.username }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="status-item warning">
                                <span class="status-icon">⚠️</span>
                                <span>暂无账号</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 任务创建表单 -->
            <div class="task-form-container">
                <div class="form-header">
                    <h2>📋 创建新任务</h2>
                    <p>输入分享链接，选择保存位置，开始自动保存</p>
                </div>

                <form action="/" method="post" id="taskForm" class="task-form">
                    <!-- 分享链接部分 -->
                    <div class="form-section">
                        <h3 class="section-title">🔗 分享链接</h3>
                        <div class="share-link-group">
                            <div class="input-group">
                                <label for="share_link">分享链接</label>
                                <input type="text" id="share_link" name="share_link" required 
                                       placeholder="请输入分享链接，例如: https://cloud.189.cn/...">
                            </div>
                            <div class="input-group">
                                <label for="access_code">访问码（可选）</label>
                                <input type="text" id="access_code" name="access_code" 
                                       placeholder="如果链接需要访问码，请在此输入">
                            </div>
                            <div class="action-group">
                                <button type="button" class="btn btn-primary" onclick="parseShareLink()">
                                    🔍 解析链接
                                </button>
                            </div>
                        </div>
                        <div id="share_parse_error" class="error-message"></div>
                    </div>

                    <!-- 分享目录选择 -->
                    <div class="form-section" id="share_folders_group" style="display: none;">
                        <h3 class="section-title">📁 选择要保存的目录</h3>
                        <div id="share_folders_list" class="folder-selection">
                            <!-- 分享目录列表将在这里动态生成 -->
                        </div>
                        <div class="section-help">
                            💡 可以选择多个目录，包括根目录和子目录
                        </div>
                    </div>

                    <!-- 账号和保存位置 -->
                    <div class="form-section">
                        <h3 class="section-title">🎯 保存设置</h3>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label for="account_id">目标账号</label>
                                <select id="account_id" name="account_id" required onchange="loadFavorites()">
                                    <option value="">请先配置项目地址和API密钥</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="save_path">保存目录</label>
                                <div class="save-path-group">
                                    <select id="save_path" name="save_path" required>
                                        <option value="">请先选择账号</option>
                                    </select>
                                    <button type="button" id="browseDirectories" class="btn btn-secondary" 
                                            onclick="showDirectoryBrowser()" style="display: none;">
                                        📂 浏览目录
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 高级选项 -->
                    <div class="form-section">
                        <h3 class="section-title">⚙️ 高级选项</h3>
                        <div class="option-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="overwrite_folder" name="overwrite_folder">
                                <span class="checkmark"></span>
                                <span class="option-text">覆盖已存在的文件夹</span>
                            </label>
                        </div>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-large">
                            🚀 创建任务
                       button>
                    </div>
                </form>
            </div>

            <!-- 消息提示 -->
            {% if message %}
            <div class="message-container">
                <div class="message {% if task_result and task_result.success %}success{% else %}error{% endif %}">
                    <span class="message-icon">
                        {% if task_result and task_result.success %}✅{% else %}❌{% endif %}
                    </span>
                    <span class="message-text">{{ message }}</span>
                </div>
            </div>
            {% endif %}
        </main>

        <!-- 目录浏览器模态框 -->
        <div id="directoryBrowser" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📂 选择保存目录</h3>
                    <button type="button" onclick="hideDirectoryBrowser()" class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <div class="current-path-display">
                        <span class="path-label">当前路径:</span>
                        <span id="currentPath" class="path-value">/</span>
                    </div>
                    <div class="directory-list" id="directoryList">
                        <!-- 目录列表将在这里动态加载 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="goToParentDirectory()">
                        ⬆️ 返回上级
                    </button>
                    <button type="button" class="btn btn-primary" onclick="selectCurrentDirectory()">
                        ✅ 选择当前目录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentDirectoryPath = '/';
        let currentFolderId = '-11';
        
        // 页面加载时获取账号列表
        window.onload = function() {
            loadAccounts();
        };

        // 获取账号列表
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                const accountSelect = document.getElementById('account_id');
                
                if (data.success && data.data.length > 0) {
                    accountSelect.innerHTML = '<option value="">请选择账号</option>';
                    data.data.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = account.username;
                        accountSelect.appendChild(option);
                    });
                } else {
                    accountSelect.innerHTML = '<option value="">暂无可用账号</option>';
                }
            } catch (error) {
                console.error('获取账号列表失败:', error);
            }
        }

        // 解析分享链接
        async function parseShareLink() {
            const shareLink = document.getElementById('share_link').value.trim();
            const accessCode = document.getElementById('access_code').value.trim();
            const accountId = document.getElementById('account_id').value;
            
            if (!shareLink) {
                showError('请输入分享链接');
                return;
            }
            
            if (!accountId) {
                showError('请先选择账号');
                return;
            }
            
            try {
                const response = await fetch('/api/parse-share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        share_link: shareLink,
                        account_id: accountId,
                        access_code: accessCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    showShareFolders(data.data);
                    hideError();
                } else {
                    showError(data.message || '解析分享链接失败');
                    hideShareFolders();
                }
            } catch (error) {
                console.error('解析分享链接失败:', error);
                showError('解析分享链接失败: ' + error.message);
                hideShareFolders();
            }
        }

        // 显示分享目录列表
        function showShareFolders(folders) {
            const container = document.getElementById('share_folders_list');
            const group = document.getElementById('share_folders_group');
            
            container.innerHTML = '';
            
            folders.forEach(folder => {
                const div = document.createElement('div');
                div.className = 'folder-option';
                div.innerHTML = `
                    <label class="folder-checkbox">
                        <input type="checkbox" name="selected_folders" value="${folder.id}" ${folder.id === '-1' ? 'checked' : ''}>
                        <span class="checkmark"></span>
                        <span class="folder-name">${folder.name}</span>
                        <span class="folder-type">${folder.id === '-1' ? '根目录' : '子目录'}</span>
                    </label>
                `;
                container.appendChild(div);
            });
            
            group.style.display = 'block';
        }

        // 隐藏分享目录列表
        function hideShareFolders() {
            document.getElementById('share_folders_group').style.display = 'none';
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // 隐藏错误信息
        function hideError() {
            document.getElementById('share_parse_error').style.display = 'none';
        }

        // 加载常用目录
        async function loadFavorites() {
            const accountId = document.getElementById('account_id').value;
            const savePathSelect = document.getElementById('save_path');
            const browseBtn = document.getElementById('browseDirectories');
            
            if (!accountId) {
                savePathSelect.innerHTML = '<option value="">请先选择账号</option>';
                browseBtn.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/favorites/${accountId}`);
                const data = await response.json();
                
                savePathSelect.innerHTML = '<option value="">请选择保存目录</option>';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(favorite => {
                        const option = document.createElement('option');
                        option.value = `${favorite.folderId || favorite.path}|${favorite.path}`;
                        option.textContent = `${favorite.name} (${favorite.path})`;
                        savePathSelect.appendChild(option);
                    });
                    browseBtn.style.display = 'none';
                } else {
                    savePathSelect.innerHTML = '<option value="">暂无常用目录</option>';
                    browseBtn.style.display = 'inline-block';
                }
            } catch (error) {
                console.error('获取常用目录失败:', error);
                savePathSelect.innerHTML = '<option value="">获取常用目录失败</option>';
                browseBtn.style.display = 'inline-block';
            }
        }

        // 显示目录浏览器
        function showDirectoryBrowser() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                alert('请先选择账号');
                return;
            }
            
            document.getElementById('directoryBrowser').style.display = 'flex';
            currentFolderId = '-11';
            currentDirectoryPath = '/';
            loadDirectoryTree();
        }

        // 隐藏目录浏览器
        function hideDirectoryBrowser() {
            document.getElementById('directoryBrowser').style.display = 'none';
        }

        // 加载目录树
        async function loadDirectoryTree() {
            const accountId = document.getElementById('account_id').value;
            const pathDisplay = document.getElementById('currentPath');
            const directoryList = document.getElementById('directoryList');
            
            pathDisplay.textContent = currentDirectoryPath;
            
            try {
                const response = await fetch(`/api/directories/${accountId}?folderId=${currentFolderId}`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    directoryList.innerHTML = data.data.map(item => `
                        <div class="directory-item" onclick="enterDirectory('${item.id}', '${item.name}')">
                            <span class="folder-icon">📁</span>
                            <span class="folder-name">${item.name}</span>
                        </div>
                    `).join('');
                } else {
                    directoryList.innerHTML = '<div class="no-directories">当前目录为空</div>';
                }
            } catch (error) {
                console.error('获取目录失败:', error);
                directoryList.innerHTML = '<div class="error">获取目录失败</div>';
            }
        }

        // 进入目录
        function enterDirectory(folderId, folderName) {
            currentFolderId = folderId;
            currentDirectoryPath = currentDirectoryPath + folderName + '/';
            loadDirectoryTree();
        }

        // 返回上级目录
        function goToParentDirectory() {
            if (currentDirectoryPath === '/') {
                return;
            }
            
            const pathParts = currentDirectoryPath.split('/').filter(part => part);
            if (pathParts.length > 0) {
                pathParts.pop();
                currentDirectoryPath = '/' + pathParts.join('/') + '/';
                
                if (pathParts.length === 0) {
                    currentFolderId = '-11';
                } else {
                    currentFolderId = '-11';
                }
                
                loadDirectoryTree();
            }
        }

        // 选择当前目录
        function selectCurrentDirectory() {
            const savePathSelect = document.getElementById('save_path');
            const option = document.createElement('option');
            option.value = `${currentFolderId}|${currentDirectoryPath}`;
            option.textContent = `当前目录 (${currentDirectoryPath})`;
            option.selected = true;
            savePathSelect.innerHTML = '';
            savePathSelect.appendChild(option);
            hideDirectoryBrowser();
        }

        // 表单提交前验证
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            const selectedFolders = document.querySelectorAll('input[name="selected_folders"]:checked');
            if (selectedFolders.length === 0) {
                e.preventDefault();
                alert('请至少选择一个要保存的目录');
                return false;
            }
        });
    </script>
</body>
</html>