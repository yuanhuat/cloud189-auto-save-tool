<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云盘自动保存</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航栏 -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title">☁️ 云盘自动保存</h1>
                    <p class="app-subtitle">智能云盘文件自动保存系统</p>
                </div>
                <div class="header-right">
                    {% if user %}
                        <div class="user-menu">
                            <span class="user-info">
                                👤 {{ user }}
                                {% if is_admin %}<span class="admin-badge">👑</span>{% endif %}
                            </span>
                            <div class="user-dropdown">
                                {% if is_admin %}
                                <a href="{{ url_for('settings') }}" class="dropdown-item">
                                    ⚙️ 系统设置
                                </a>
                                <a href="{{ url_for('users') }}" class="dropdown-item">
                                    👥 用户管理
                                </a>
                                <a href="{{ url_for('account_directories') }}" class="dropdown-item">
                                    📁 账号目录映射
                                </a>
                                <a href="{{ url_for('tasks') }}" class="dropdown-item">
                                    📋 任务管理
                                </a>
                                <a href="{{ url_for('auto_delete_config') }}" class="dropdown-item">
                                    🗑️ 自动删除配置
                                </a>
                                {% endif %}
                                <a href="{{ url_for('logout') }}" class="dropdown-item">
                                    🚪 退出登录
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="auth-buttons">
                            <a href="{{ url_for('login') }}" class="btn btn-secondary">
                                🔐 登录
                            </a>
                            <a href="{{ url_for('register') }}" class="btn btn-primary">
                                📝 注册
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 状态信息卡片 -->
            <div class="status-cards">
                <!-- 配置状态 -->
                <div class="status-card">
                    <div class="card-header">
                        <span class="card-icon">🔧</span>
                        <h3>配置状态</h3>
                    </div>
                    <div class="card-content">
                        {% if settings and (settings.project_address or settings.api_key) %}
                            <div class="status-item success">
                                <span class="status-icon">✅</span>
                                <span>已配置</span>
                            </div>

                        {% else %}
                            <div class="status-item error">
                                <span class="status-icon">❌</span>
                                <span>未配置</span>
                            </div>
                            {% if user and is_admin %}
                                <a href="{{ url_for('settings') }}" class="config-link">点击配置</a>
                            {% else %}
                                <span class="config-link disabled">需要管理员权限</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- 账号信息 -->
                <div class="status-card">
                    <div class="card-header">
                        <span class="card-icon">👤</span>
                        <h3>账号信息</h3>
                    </div>
                    <div class="card-content">
                        {% if accounts %}
                            {% for account in accounts %}
                            <div class="account-item">
                                <span class="account-id">#{{ account.id }}</span>
                                <span class="account-name">{{ account.username }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="status-item warning">
                                <span class="status-icon">⚠️</span>
                                <span>暂无账号</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 任务创建表单 -->
            <div class="task-form-container">
                <div class="form-header">
                    <h2>📋 创建新任务</h2>
                    <p>输入分享链接，选择保存位置，开始自动保存</p>
                </div>

                <form action="/" method="post" id="taskForm" class="task-form">
                    <!-- 分享链接部分 -->
                    <div class="form-section">
                        <h3 class="section-title">🔗 分享链接</h3>
                        
                        <!-- 输入模式切换 -->
                        <div class="input-mode-switch">
                            <label class="radio-label">
                                <input type="radio" name="input_mode" value="single" checked onchange="switchInputMode()">
                                <span class="radio-custom"></span>
                                <span class="radio-text">单个链接</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="input_mode" value="batch" onchange="switchInputMode()">
                                <span class="radio-custom"></span>
                                <span class="radio-text">批量链接</span>
                            </label>
                        </div>
                        
                        <!-- 单个链接输入 -->
                        <div id="single_link_input" class="link-input-section">
                            <div class="share-link-group">
                                <div class="input-group">
                                    <label for="share_link">分享链接</label>
                                    <input type="text" id="share_link" name="share_link" 
                                           placeholder="请输入分享链接，例如: https://cloud.189.cn/...">
                                </div>
                                <div class="input-group">
                                    <label for="access_code">访问码（可选）</label>
                                    <input type="text" id="access_code" name="access_code" 
                                           placeholder="如果链接需要访问码，请在此输入">
                                </div>
                                <div class="action-group">
                                    <button type="button" class="btn btn-primary" onclick="parseShareLink()">
                                        🔍 解析链接
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 批量链接输入 -->
                        <div id="batch_link_input" class="link-input-section" style="display: none;">
                            <div class="input-group">
                                <label for="batch_links">批量分享链接</label>
                                <textarea id="batch_links" name="batch_links" 
                                          placeholder="请输入多个分享链接，每行一个链接&#10;例如:&#10;https://cloud.189.cn/share1&#10;https://cloud.189.cn/share2&#10;https://cloud.189.cn/share3" 
                                          rows="6"></textarea>
                                <div class="batch-input-help">
                                    <small>💡 每行输入一个分享链接，支持带访问码的链接</small><br>
                                    <small>💡 格式：链接 [访问码]（访问码可选）</small><br>
                                    <small>💡 示例：https://cloud.189.cn/share1 123456</small>
                                </div>
                                <div class="action-group">
                                    <button type="button" class="btn btn-primary" onclick="parseBatchLinks()">
                                        🔍 批量解析
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="share_parse_error" class="error-message"></div>
                    </div>

                    <!-- 分享目录选择 -->
                    <div class="form-section" id="share_folders_group" style="display: none;">
                        <h3 class="section-title">📁 选择要保存的目录</h3>
                        <div id="share_folders_list" class="folder-selection">
                            <!-- 分享目录列表将在这里动态生成 -->
                        </div>
                        <div class="section-help">
                            💡 可以选择多个目录，包括根目录和子目录
                        </div>
                    </div>

                    <!-- 账号和保存位置 -->
                    <div class="form-section">
                        <h3 class="section-title">🎯 保存设置</h3>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label for="account_id">目标账号</label>
                                <select id="account_id" name="account_id" required onchange="handleAccountChange();">
                                    <option value="">请先配置项目地址和API密钥</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="save_path">保存目录</label>
                                <div class="save-path-group">
                                    <select id="save_path" name="save_path" required>
                                        <option value="">请先选择账号</option>
                                    </select>
                                    <button type="button" id="browseDirectories" class="btn btn-secondary" 
                                            onclick="showDirectoryBrowser()" style="display: none;">
                                        📂 浏览目录
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 高级选项 -->
                    <div class="form-section">
                        <h3 class="section-title">⚙️ 高级选项</h3>
                        <div class="option-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="overwrite_folder" name="overwrite_folder">
                                <span class="checkmark"></span>
                                <span class="option-text">覆盖已存在的文件夹</span>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="enable_cron" name="enable_cron">
                                <span class="checkmark"></span>
                                <span class="option-text">启用自定义定时任务</span>
                            </label>
                        </div>
                        
                        <!-- 定时任务配置 -->
                        <div id="cron_config" class="cron-config" style="display: none;">
                            <div class="input-group">
                                <label for="cron_expression">Cron表达式</label>
                                <input type="text" id="cron_expression" name="cron_expression" 
                                       placeholder="例如: 0 */30 * * * * (每30分钟执行)">
                                <div class="cron-examples">
                                    <small>常用示例:</small><br>
                                    <small>• 每30分钟执行: <code>0 */30 * * * *</code></small><br>
                                    <small>• 每天凌晨2点执行: <code>0 0 2 * * *</code></small><br>
                                    <small>• 每2小时执行: <code>0 0 */2 * * *</code></small><br>
                                    <small>• 每天9-18点整点执行: <code>0 0 9-18 * * *</code></small><br>
                                    <small>• 每周一凌晨2点30分: <code>0 30 2 * * 1</code></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-large">
                            🚀 创建任务
                       button>
                    </div>
        </form>
            </div>

            <!-- 消息提示 -->
            {% if message %}
            <div class="message-container">
                <div class="message {% if task_result and task_result.success %}success{% else %}error{% endif %}">
                    <span class="message-icon">
                        {% if task_result and task_result.success %}✅{% else %}❌{% endif %}
                    </span>
                    <span class="message-text">{{ message }}</span>
                </div>
            </div>
            {% endif %}
        </main>

        <!-- 目录浏览器模态框 -->
        <div id="directoryBrowser" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📂 选择保存目录</h3>
                    <button type="button" onclick="hideDirectoryBrowser()" class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <div class="current-path-display">
                        <span class="path-label">当前路径:</span>
                        <span id="currentPath" class="path-value">/</span>
                    </div>
                    <div class="directory-list" id="directoryList">
                        <!-- 目录列表将在这里动态加载 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="goToParentDirectory()">
                        ⬆️ 返回上级
                    </button>
                    <button type="button" class="btn btn-primary" onclick="selectCurrentDirectory()">
                        ✅ 选择当前目录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentDirectoryPath = '/';
        let currentFolderId = '-11';
        let directoryStack = []; // 用于维护目录层级
        
        // 页面加载时获取账号列表
        window.onload = function() {
            loadAccounts();
        };

        // 获取账号列表
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                const accountSelect = document.getElementById('account_id');
                
                if (data.success && data.data.length > 0) {
                    accountSelect.innerHTML = '<option value="">请选择账号</option>';
                    data.data.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = account.username;
                        accountSelect.appendChild(option);
                    });
                } else {
                    accountSelect.innerHTML = '<option value="">暂无可用账号</option>';
                }
            } catch (error) {
                console.error('获取账号列表失败:', error);
            }
        }

        // 解析分享链接
        async function parseShareLink() {
            const shareLink = document.getElementById('share_link').value.trim();
            const accessCode = document.getElementById('access_code').value.trim();
            const accountId = document.getElementById('account_id').value;
            
            if (!shareLink) {
                showError('请输入分享链接');
                return;
            }
            
            if (!accountId) {
                showError('请先选择账号');
                return;
            }
            
            try {
                const response = await fetch('/api/parse-share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        share_link: shareLink,
                        account_id: accountId,
                        access_code: accessCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    showShareFolders(data.data);
                    hideError();
                } else {
                    showError(data.message || '解析分享链接失败');
                    hideShareFolders();
                }
            } catch (error) {
                console.error('解析分享链接失败:', error);
                showError('解析分享链接失败: ' + error.message);
                hideShareFolders();
            }
        }

        // 显示分享目录列表
        function showShareFolders(folders) {
            const container = document.getElementById('share_folders_list');
            const group = document.getElementById('share_folders_group');
            
            container.innerHTML = '';
            
            folders.forEach(folder => {
                const div = document.createElement('div');
                div.className = 'folder-option';
                div.innerHTML = `
                    <label class="folder-checkbox">
                        <input type="checkbox" name="selected_folders" value="${folder.id}" ${folder.id === '-1' ? 'checked' : ''}>
                        <span class="checkmark"></span>
                        <span class="folder-name">${folder.name}</span>
                        <span class="folder-type">${folder.id === '-1' ? '根目录' : '子目录'}</span>
                    </label>
                `;
                container.appendChild(div);
            });
            
            group.style.display = 'block';
        }

        // 隐藏分享目录列表
        function hideShareFolders() {
            document.getElementById('share_folders_group').style.display = 'none';
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // 隐藏错误信息
        function hideError() {
            document.getElementById('share_parse_error').style.display = 'none';
        }

        // 加载常用目录
        async function loadFavorites() {
            const accountId = document.getElementById('account_id').value;
            const savePathSelect = document.getElementById('save_path');
            const browseBtn = document.getElementById('browseDirectories');
            
            if (!accountId) {
                savePathSelect.innerHTML = '<option value="">请先选择账号</option>';
                browseBtn.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/favorites/${accountId}`);
                const data = await response.json();
                
                // 检查是否已经有账号目录映射
                const hasMapping = savePathSelect.querySelector('option[data-mapping="true"]');
                if (hasMapping) {
                    // 如果已经有映射，不覆盖，只隐藏浏览按钮
                    browseBtn.style.display = 'none';
                    return;
                }
                
                savePathSelect.innerHTML = '<option value="">请选择保存目录</option>';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(favorite => {
                        const option = document.createElement('option');
                        option.value = `${favorite.folderId || favorite.path}|${favorite.path}`;
                        option.textContent = `${favorite.name} (${favorite.path})`;
                        savePathSelect.appendChild(option);
                    });
                    browseBtn.style.display = 'none';
                } else {
                    savePathSelect.innerHTML = '<option value="">暂无常用目录</option>';
                    browseBtn.style.display = 'inline-block';
                }
            } catch (error) {
                console.error('获取常用目录失败:', error);
                savePathSelect.innerHTML = '<option value="">获取常用目录失败</option>';
                browseBtn.style.display = 'inline-block';
            }
        }

        // 显示目录浏览器
        function showDirectoryBrowser() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                alert('请先选择账号');
                return;
            }
            
            document.getElementById('directoryBrowser').style.display = 'flex';
            currentFolderId = '-11';
            currentDirectoryPath = '/';
            directoryStack = []; // 重置目录栈
            loadDirectoryTree();
        }

        // 隐藏目录浏览器
        function hideDirectoryBrowser() {
            document.getElementById('directoryBrowser').style.display = 'none';
        }

        // 加载目录树
        async function loadDirectoryTree() {
            const accountId = document.getElementById('account_id').value;
            const pathDisplay = document.getElementById('currentPath');
            const directoryList = document.getElementById('directoryList');
            
            pathDisplay.textContent = currentDirectoryPath;
            console.log(`加载目录树: accountId=${accountId}, folderId=${currentFolderId}, path=${currentDirectoryPath}`);
            
            try {
                const response = await fetch(`/api/directories/${accountId}?folderId=${currentFolderId}`);
                const data = await response.json();
                
                console.log('目录树响应:', data);
                
                if (data.success && data.data.length > 0) {
                    directoryList.innerHTML = data.data.map(item => `
                        <div class="directory-item" onclick="enterDirectory('${item.id}', '${item.name}')">
                            <span class="folder-icon">📁</span>
                            <span class="folder-name">${item.name}</span>
                        </div>
                    `).join('');
                } else {
                    directoryList.innerHTML = '<div class="no-directories">当前目录为空</div>';
                }
            } catch (error) {
                console.error('获取目录失败:', error);
                directoryList.innerHTML = '<div class="error">获取目录失败</div>';
            }
        }

        // 进入目录
        function enterDirectory(folderId, folderName) {
            // 将当前目录信息推入栈中
            directoryStack.push({
                id: currentFolderId,
                name: folderName,
                path: currentDirectoryPath
            });
            
            currentFolderId = folderId;
            currentDirectoryPath = currentDirectoryPath + folderName + '/';
            loadDirectoryTree();
        }

        // 返回上级目录
        function goToParentDirectory() {
            if (currentDirectoryPath === '/' || directoryStack.length === 0) {
                return;
            }
            
            // 从栈中弹出上级目录信息
            const parentDir = directoryStack.pop();
            currentFolderId = parentDir.id;
            currentDirectoryPath = parentDir.path;
            
            loadDirectoryTree();
        }

        // 选择当前目录
        function selectCurrentDirectory() {
            const savePathSelect = document.getElementById('save_path');
            const option = document.createElement('option');
            
            // 确保路径格式正确
            let displayPath = currentDirectoryPath;
            if (displayPath.endsWith('/') && displayPath !== '/') {
                displayPath = displayPath.slice(0, -1);
            }
            
            option.value = `${currentFolderId}|${currentDirectoryPath}`;
            option.textContent = `当前目录 (${displayPath})`;
            option.selected = true;
            savePathSelect.innerHTML = '';
            savePathSelect.appendChild(option);
            hideDirectoryBrowser();
        }

        // 监听定时任务复选框变化
        document.getElementById('enable_cron').addEventListener('change', function() {
            const cronConfig = document.getElementById('cron_config');
            cronConfig.style.display = this.checked ? 'block' : 'none';
        });

        // 切换输入模式
        function switchInputMode() {
            const singleInput = document.getElementById('single_link_input');
            const batchInput = document.getElementById('batch_link_input');
            const singleRadio = document.querySelector('input[name="input_mode"][value="single"]');
            
            if (singleRadio.checked) {
                singleInput.style.display = 'block';
                batchInput.style.display = 'none';
                // 设置单个链接为必填
                document.getElementById('share_link').required = true;
                document.getElementById('batch_links').required = false;
            } else {
                singleInput.style.display = 'none';
                batchInput.style.display = 'block';
                // 设置批量链接为必填
                document.getElementById('share_link').required = false;
                document.getElementById('batch_links').required = true;
            }
        }

        // 批量解析链接
        async function parseBatchLinks() {
            const batchLinks = document.getElementById('batch_links').value.trim();
            const accountId = document.getElementById('account_id').value;
            
            if (!batchLinks) {
                showError('请输入批量分享链接');
                return;
            }
            
            if (!accountId) {
                showError('请先选择账号');
                return;
            }
            
            // 解析批量链接
            const links = batchLinks.split('\n').filter(line => line.trim());
            if (links.length === 0) {
                showError('没有找到有效的分享链接');
                return;
            }
            
            console.log(`开始批量解析 ${links.length} 个链接...`);
            
            // 显示批量处理状态
            showBatchProgress(links.length);
            
            // 逐个解析链接
            const results = [];
            for (let i = 0; i < links.length; i++) {
                const line = links[i].trim();
                if (!line) continue;
                
                // 解析链接和访问码
                const parts = line.split(/\s+/);
                const shareLink = parts[0];
                const accessCode = parts[1] || '';
                
                try {
                    const response = await fetch('/api/parse-share', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            share_link: shareLink,
                            account_id: accountId,
                            access_code: accessCode
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data.length > 0) {
                        results.push({
                            shareLink: shareLink,
                            accessCode: accessCode,
                            folders: data.data,
                            success: true
                        });
                        updateBatchProgress(i + 1, links.length, `✅ 链接 ${i + 1} 解析成功`);
                    } else {
                        results.push({
                            shareLink: shareLink,
                            accessCode: accessCode,
                            error: data.message || '解析失败',
                            success: false
                        });
                        updateBatchProgress(i + 1, links.length, `❌ 链接 ${i + 1} 解析失败: ${data.message}`);
                    }
                } catch (error) {
                    results.push({
                        shareLink: shareLink,
                        accessCode: accessCode,
                        error: error.message,
                        success: false
                    });
                    updateBatchProgress(i + 1, links.length, `❌ 链接 ${i + 1} 解析失败: ${error.message}`);
                }
            }
            
            // 显示批量解析结果
            showBatchResults(results);
        }

        // 显示批量处理进度
        function showBatchProgress(total) {
            const progressHtml = `
                <div id="batch_progress" class="batch-progress">
                    <div class="progress-header">
                        <h4>🔄 批量解析进度</h4>
                        <span id="progress_text">0 / ${total}</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress_fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="progress_status" class="progress-status">准备开始...</div>
                </div>
            `;
            
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.innerHTML = progressHtml;
            errorDiv.className = 'batch-progress-container';
        }

        // 更新批量处理进度
        function updateBatchProgress(current, total, status) {
            const progressFill = document.getElementById('progress_fill');
            const progressText = document.getElementById('progress_text');
            const progressStatus = document.getElementById('progress_status');
            
            if (progressFill && progressText && progressStatus) {
                const percentage = (current / total) * 100;
                progressFill.style.width = percentage + '%';
                progressText.textContent = `${current} / ${total}`;
                progressStatus.textContent = status;
            }
        }

        // 显示批量解析结果
        function showBatchResults(results) {
            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;
            
            let resultHtml = `
                <div class="batch-results">
                    <div class="results-summary">
                        <h4>📊 批量解析结果</h4>
                        <div class="results-stats">
                            <span class="stat-success">✅ 成功: ${successCount}</span>
                            <span class="stat-fail">❌ 失败: ${failCount}</span>
                        </div>
                    </div>
            `;
            
            if (successCount > 0) {
                resultHtml += '<div class="success-links">';
                results.filter(r => r.success).forEach((result, index) => {
                    resultHtml += `
                        <div class="link-result success">
                            <div class="link-info">
                                <span class="link-number">#${index + 1}</span>
                                <span class="link-url">${result.shareLink}</span>
                                ${result.accessCode ? `<span class="access-code">访问码: ${result.accessCode}</span>` : ''}
                            </div>
                            <div class="folder-count">找到 ${result.folders.length} 个目录</div>
                        </div>
                    `;
                });
                resultHtml += '</div>';
            }
            
            if (failCount > 0) {
                resultHtml += '<div class="failed-links">';
                results.filter(r => !r.success).forEach((result, index) => {
                    resultHtml += `
                        <div class="link-result fail">
                            <div class="link-info">
                                <span class="link-number">#${index + 1}</span>
                                <span class="link-url">${result.shareLink}</span>
                                ${result.accessCode ? `<span class="access-code">访问码: ${result.accessCode}</span>` : ''}
                            </div>
                            <div class="error-message">${result.error}</div>
                        </div>
                    `;
                });
                resultHtml += '</div>';
            }
            
            resultHtml += '</div>';
            
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.innerHTML = resultHtml;
            errorDiv.className = 'batch-results-container';
        }

        // 处理账号变更
        async function handleAccountChange() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                // 清空保存目录选择
                const savePathSelect = document.getElementById('save_path');
                const browseBtn = document.getElementById('browseDirectories');
                savePathSelect.innerHTML = '<option value="">请先选择账号</option>';
                browseBtn.style.display = 'none';
                return;
            }
            
            // 首先尝试加载账号目录映射
            await loadAccountDirectory();
            
            // 然后加载常用目录（如果映射失败）
            await loadFavorites();
        }
        
        // 加载账号目录映射
        async function loadAccountDirectory() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                return;
            }
            
            try {
                const response = await fetch(`/api/account-directory/${accountId}`);
                const data = await response.json();
                
                if (data.success) {
                    // 自动设置保存目录
                    const savePathSelect = document.getElementById('save_path');
                    const browseBtn = document.getElementById('browseDirectories');
                    const folderId = data.data.target_folder_id;
                    const folderPath = data.data.target_folder_path;
                    const folderName = data.data.folder_name;
                    
                    // 创建新的选项
                    const option = document.createElement('option');
                    option.value = `${folderId}|${folderPath}`;
                    option.textContent = `🎯 ${folderName} (${folderPath}) [专用映射]`;
                    option.selected = true;
                    option.setAttribute('data-mapping', 'true'); // 标记为映射选项
                    
                    // 清空现有选项并添加新选项
                    savePathSelect.innerHTML = '';
                    savePathSelect.appendChild(option);
                    
                    // 隐藏浏览按钮，因为已经有专用映射
                    browseBtn.style.display = 'none';
                    
                    // 显示成功消息
                    showMessage(`✅ 已自动应用账号 ${accountId} 的专用保存目录: ${folderName}`, 'success');
                } else {
                    // 如果没有映射，显示提示
                    showMessage(`ℹ️ 账号 ${accountId} 未配置专用保存目录，请手动选择`, 'info');
                }
            } catch (error) {
                console.error('加载账号目录映射失败:', error);
                showMessage('❌ 加载账号目录映射失败', 'error');
            }
        }
        
        // 显示消息
        function showMessage(message, type) {
            // 创建消息元素
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <span class="message-icon">
                    ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}
                </span>
                <span class="message-text">${message}</span>
            `;
            
            // 插入到页面顶部
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(messageDiv, mainContent.firstChild);
            
            // 3秒后自动移除
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // 表单提交前验证
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            const selectedFolders = document.querySelectorAll('input[name="selected_folders"]:checked');
            if (selectedFolders.length === 0) {
                e.preventDefault();
                alert('请至少选择一个要保存的目录');
                return false;
            }
            
            // 验证定时任务
            const enableCron = document.getElementById('enable_cron').checked;
            const cronExpression = document.getElementById('cron_expression').value.trim();
            if (enableCron && !cronExpression) {
                e.preventDefault();
                alert('启用定时任务时必须填写Cron表达式');
                return false;
            }
        });
    </script>
</body>
</html>