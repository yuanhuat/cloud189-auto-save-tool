<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç›˜è‡ªåŠ¨ä¿å­˜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title">â˜ï¸ äº‘ç›˜è‡ªåŠ¨ä¿å­˜</h1>
                    <p class="app-subtitle">æ™ºèƒ½äº‘ç›˜æ–‡ä»¶è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ</p>
                </div>
                <div class="header-right">
                    {% if user %}
                        <div class="user-menu">
                            <span class="user-info">
                                ğŸ‘¤ {{ user }}
                                {% if is_admin %}<span class="admin-badge">ğŸ‘‘</span>{% endif %}
                            </span>
                            <div class="user-dropdown">
                                {% if is_admin %}
                                <a href="{{ url_for('settings') }}" class="dropdown-item">
                                    âš™ï¸ ç³»ç»Ÿè®¾ç½®
                                </a>
                                <a href="{{ url_for('users') }}" class="dropdown-item">
                                    ğŸ‘¥ ç”¨æˆ·ç®¡ç†
                                </a>
                                <a href="{{ url_for('account_directories') }}" class="dropdown-item">
                                    ğŸ“ è´¦å·ç›®å½•æ˜ å°„
                                </a>
                                <a href="{{ url_for('tasks') }}" class="dropdown-item">
                                    ğŸ“‹ ä»»åŠ¡ç®¡ç†
                                </a>
                                <a href="{{ url_for('auto_delete_config') }}" class="dropdown-item">
                                    ğŸ—‘ï¸ è‡ªåŠ¨åˆ é™¤é…ç½®
                                </a>
                                {% endif %}
                                <a href="{{ url_for('logout') }}" class="dropdown-item">
                                    ğŸšª é€€å‡ºç™»å½•
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="auth-buttons">
                            <a href="{{ url_for('login') }}" class="btn btn-secondary">
                                ğŸ” ç™»å½•
                            </a>
                            <a href="{{ url_for('register') }}" class="btn btn-primary">
                                ğŸ“ æ³¨å†Œ
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- çŠ¶æ€ä¿¡æ¯å¡ç‰‡ -->
            <div class="status-cards">
                <!-- é…ç½®çŠ¶æ€ -->
                <div class="status-card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ”§</span>
                        <h3>é…ç½®çŠ¶æ€</h3>
                    </div>
                    <div class="card-content">
                        {% if settings and (settings.project_address or settings.api_key) %}
                            <div class="status-item success">
                                <span class="status-icon">âœ…</span>
                                <span>å·²é…ç½®</span>
                            </div>

                        {% else %}
                            <div class="status-item error">
                                <span class="status-icon">âŒ</span>
                                <span>æœªé…ç½®</span>
                            </div>
                            {% if user and is_admin %}
                                <a href="{{ url_for('settings') }}" class="config-link">ç‚¹å‡»é…ç½®</a>
                            {% else %}
                                <span class="config-link disabled">éœ€è¦ç®¡ç†å‘˜æƒé™</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- è´¦å·ä¿¡æ¯ -->
                <div class="status-card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ‘¤</span>
                        <h3>è´¦å·ä¿¡æ¯</h3>
                    </div>
                    <div class="card-content">
                        {% if accounts %}
                            {% for account in accounts %}
                            <div class="account-item">
                                <span class="account-id">#{{ account.id }}</span>
                                <span class="account-name">{{ account.username }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="status-item warning">
                                <span class="status-icon">âš ï¸</span>
                                <span>æš‚æ— è´¦å·</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ›å»ºè¡¨å• -->
            <div class="task-form-container">
                <div class="form-header">
                    <h2>ğŸ“‹ åˆ›å»ºæ–°ä»»åŠ¡</h2>
                    <p>è¾“å…¥åˆ†äº«é“¾æ¥ï¼Œé€‰æ‹©ä¿å­˜ä½ç½®ï¼Œå¼€å§‹è‡ªåŠ¨ä¿å­˜</p>
                </div>

                <form action="/" method="post" id="taskForm" class="task-form">
                    <!-- åˆ†äº«é“¾æ¥éƒ¨åˆ† -->
                    <div class="form-section">
                        <h3 class="section-title">ğŸ”— åˆ†äº«é“¾æ¥</h3>
                        
                        <!-- è¾“å…¥æ¨¡å¼åˆ‡æ¢ -->
                        <div class="input-mode-switch">
                            <label class="radio-label">
                                <input type="radio" name="input_mode" value="single" checked onchange="switchInputMode()">
                                <span class="radio-custom"></span>
                                <span class="radio-text">å•ä¸ªé“¾æ¥</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="input_mode" value="batch" onchange="switchInputMode()">
                                <span class="radio-custom"></span>
                                <span class="radio-text">æ‰¹é‡é“¾æ¥</span>
                            </label>
                        </div>
                        
                        <!-- å•ä¸ªé“¾æ¥è¾“å…¥ -->
                        <div id="single_link_input" class="link-input-section">
                            <div class="share-link-group">
                                <div class="input-group">
                                    <label for="share_link">åˆ†äº«é“¾æ¥</label>
                                    <input type="text" id="share_link" name="share_link" 
                                           placeholder="è¯·è¾“å…¥åˆ†äº«é“¾æ¥ï¼Œä¾‹å¦‚: https://cloud.189.cn/...">
                                </div>
                                <div class="input-group">
                                    <label for="access_code">è®¿é—®ç ï¼ˆå¯é€‰ï¼‰</label>
                                    <input type="text" id="access_code" name="access_code" 
                                           placeholder="å¦‚æœé“¾æ¥éœ€è¦è®¿é—®ç ï¼Œè¯·åœ¨æ­¤è¾“å…¥">
                                </div>
                                <div class="action-group">
                                    <button type="button" class="btn btn-primary" onclick="parseShareLink()">
                                        ğŸ” è§£æé“¾æ¥
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ‰¹é‡é“¾æ¥è¾“å…¥ -->
                        <div id="batch_link_input" class="link-input-section" style="display: none;">
                            <div class="input-group">
                                <label for="batch_links">æ‰¹é‡åˆ†äº«é“¾æ¥</label>
                                <textarea id="batch_links" name="batch_links" 
                                          placeholder="è¯·è¾“å…¥å¤šä¸ªåˆ†äº«é“¾æ¥ï¼Œæ¯è¡Œä¸€ä¸ªé“¾æ¥&#10;ä¾‹å¦‚:&#10;https://cloud.189.cn/share1&#10;https://cloud.189.cn/share2&#10;https://cloud.189.cn/share3" 
                                          rows="6"></textarea>
                                <div class="batch-input-help">
                                    <small>ğŸ’¡ æ¯è¡Œè¾“å…¥ä¸€ä¸ªåˆ†äº«é“¾æ¥ï¼Œæ”¯æŒå¸¦è®¿é—®ç çš„é“¾æ¥</small><br>
                                    <small>ğŸ’¡ æ ¼å¼ï¼šé“¾æ¥ [è®¿é—®ç ]ï¼ˆè®¿é—®ç å¯é€‰ï¼‰</small><br>
                                    <small>ğŸ’¡ ç¤ºä¾‹ï¼šhttps://cloud.189.cn/share1 123456</small>
                                </div>
                                <div class="action-group">
                                    <button type="button" class="btn btn-primary" onclick="parseBatchLinks()">
                                        ğŸ” æ‰¹é‡è§£æ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="share_parse_error" class="error-message"></div>
                    </div>

                    <!-- åˆ†äº«ç›®å½•é€‰æ‹© -->
                    <div class="form-section" id="share_folders_group" style="display: none;">
                        <h3 class="section-title">ğŸ“ é€‰æ‹©è¦ä¿å­˜çš„ç›®å½•</h3>
                        <div id="share_folders_list" class="folder-selection">
                            <!-- åˆ†äº«ç›®å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div class="section-help">
                            ğŸ’¡ å¯ä»¥é€‰æ‹©å¤šä¸ªç›®å½•ï¼ŒåŒ…æ‹¬æ ¹ç›®å½•å’Œå­ç›®å½•
                        </div>
                    </div>

                    <!-- è´¦å·å’Œä¿å­˜ä½ç½® -->
                    <div class="form-section">
                        <h3 class="section-title">ğŸ¯ ä¿å­˜è®¾ç½®</h3>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label for="account_id">ç›®æ ‡è´¦å·</label>
                                <select id="account_id" name="account_id" required onchange="handleAccountChange();">
                                    <option value="">è¯·å…ˆé…ç½®é¡¹ç›®åœ°å€å’ŒAPIå¯†é’¥</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="save_path">ä¿å­˜ç›®å½•</label>
                                <div class="save-path-group">
                                    <select id="save_path" name="save_path" required>
                                        <option value="">è¯·å…ˆé€‰æ‹©è´¦å·</option>
                                    </select>
                                    <button type="button" id="browseDirectories" class="btn btn-secondary" 
                                            onclick="showDirectoryBrowser()" style="display: none;">
                                        ğŸ“‚ æµè§ˆç›®å½•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é«˜çº§é€‰é¡¹ -->
                    <div class="form-section">
                        <h3 class="section-title">âš™ï¸ é«˜çº§é€‰é¡¹</h3>
                        <div class="option-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="overwrite_folder" name="overwrite_folder">
                                <span class="checkmark"></span>
                                <span class="option-text">è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶å¤¹</span>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="enable_cron" name="enable_cron">
                                <span class="checkmark"></span>
                                <span class="option-text">å¯ç”¨è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡</span>
                            </label>
                        </div>
                        
                        <!-- å®šæ—¶ä»»åŠ¡é…ç½® -->
                        <div id="cron_config" class="cron-config" style="display: none;">
                            <div class="input-group">
                                <label for="cron_expression">Cronè¡¨è¾¾å¼</label>
                                <input type="text" id="cron_expression" name="cron_expression" 
                                       placeholder="ä¾‹å¦‚: 0 */30 * * * * (æ¯30åˆ†é’Ÿæ‰§è¡Œ)">
                                <div class="cron-examples">
                                    <small>å¸¸ç”¨ç¤ºä¾‹:</small><br>
                                    <small>â€¢ æ¯30åˆ†é’Ÿæ‰§è¡Œ: <code>0 */30 * * * *</code></small><br>
                                    <small>â€¢ æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ: <code>0 0 2 * * *</code></small><br>
                                    <small>â€¢ æ¯2å°æ—¶æ‰§è¡Œ: <code>0 0 */2 * * *</code></small><br>
                                    <small>â€¢ æ¯å¤©9-18ç‚¹æ•´ç‚¹æ‰§è¡Œ: <code>0 0 9-18 * * *</code></small><br>
                                    <small>â€¢ æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹30åˆ†: <code>0 30 2 * * 1</code></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success btn-large">
                            ğŸš€ åˆ›å»ºä»»åŠ¡
                       button>
                    </div>
        </form>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            {% if message %}
            <div class="message-container">
                <div class="message {% if task_result and task_result.success %}success{% else %}error{% endif %}">
                    <span class="message-icon">
                        {% if task_result and task_result.success %}âœ…{% else %}âŒ{% endif %}
                    </span>
                    <span class="message-text">{{ message }}</span>
                </div>
            </div>
            {% endif %}
        </main>

        <!-- ç›®å½•æµè§ˆå™¨æ¨¡æ€æ¡† -->
        <div id="directoryBrowser" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“‚ é€‰æ‹©ä¿å­˜ç›®å½•</h3>
                    <button type="button" onclick="hideDirectoryBrowser()" class="modal-close">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="current-path-display">
                        <span class="path-label">å½“å‰è·¯å¾„:</span>
                        <span id="currentPath" class="path-value">/</span>
                    </div>
                    <div class="directory-list" id="directoryList">
                        <!-- ç›®å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="goToParentDirectory()">
                        â¬†ï¸ è¿”å›ä¸Šçº§
                    </button>
                    <button type="button" class="btn btn-primary" onclick="selectCurrentDirectory()">
                        âœ… é€‰æ‹©å½“å‰ç›®å½•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentDirectoryPath = '/';
        let currentFolderId = '-11';
        let directoryStack = []; // ç”¨äºç»´æŠ¤ç›®å½•å±‚çº§
        
        // é¡µé¢åŠ è½½æ—¶è·å–è´¦å·åˆ—è¡¨
        window.onload = function() {
            loadAccounts();
        };

        // è·å–è´¦å·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                const accountSelect = document.getElementById('account_id');
                
                if (data.success && data.data.length > 0) {
                    accountSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·</option>';
                    data.data.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = account.username;
                        accountSelect.appendChild(option);
                    });
                } else {
                    accountSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨è´¦å·</option>';
                }
            } catch (error) {
                console.error('è·å–è´¦å·åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // è§£æåˆ†äº«é“¾æ¥
        async function parseShareLink() {
            const shareLink = document.getElementById('share_link').value.trim();
            const accessCode = document.getElementById('access_code').value.trim();
            const accountId = document.getElementById('account_id').value;
            
            if (!shareLink) {
                showError('è¯·è¾“å…¥åˆ†äº«é“¾æ¥');
                return;
            }
            
            if (!accountId) {
                showError('è¯·å…ˆé€‰æ‹©è´¦å·');
                return;
            }
            
            try {
                const response = await fetch('/api/parse-share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        share_link: shareLink,
                        account_id: accountId,
                        access_code: accessCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    showShareFolders(data.data);
                    hideError();
                } else {
                    showError(data.message || 'è§£æåˆ†äº«é“¾æ¥å¤±è´¥');
                    hideShareFolders();
                }
            } catch (error) {
                console.error('è§£æåˆ†äº«é“¾æ¥å¤±è´¥:', error);
                showError('è§£æåˆ†äº«é“¾æ¥å¤±è´¥: ' + error.message);
                hideShareFolders();
            }
        }

        // æ˜¾ç¤ºåˆ†äº«ç›®å½•åˆ—è¡¨
        function showShareFolders(folders) {
            const container = document.getElementById('share_folders_list');
            const group = document.getElementById('share_folders_group');
            
            container.innerHTML = '';
            
            folders.forEach(folder => {
                const div = document.createElement('div');
                div.className = 'folder-option';
                div.innerHTML = `
                    <label class="folder-checkbox">
                        <input type="checkbox" name="selected_folders" value="${folder.id}" ${folder.id === '-1' ? 'checked' : ''}>
                        <span class="checkmark"></span>
                        <span class="folder-name">${folder.name}</span>
                        <span class="folder-type">${folder.id === '-1' ? 'æ ¹ç›®å½•' : 'å­ç›®å½•'}</span>
                    </label>
                `;
                container.appendChild(div);
            });
            
            group.style.display = 'block';
        }

        // éšè—åˆ†äº«ç›®å½•åˆ—è¡¨
        function hideShareFolders() {
            document.getElementById('share_folders_group').style.display = 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('share_parse_error').style.display = 'none';
        }

        // åŠ è½½å¸¸ç”¨ç›®å½•
        async function loadFavorites() {
            const accountId = document.getElementById('account_id').value;
            const savePathSelect = document.getElementById('save_path');
            const browseBtn = document.getElementById('browseDirectories');
            
            if (!accountId) {
                savePathSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©è´¦å·</option>';
                browseBtn.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/favorites/${accountId}`);
                const data = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è´¦å·ç›®å½•æ˜ å°„
                const hasMapping = savePathSelect.querySelector('option[data-mapping="true"]');
                if (hasMapping) {
                    // å¦‚æœå·²ç»æœ‰æ˜ å°„ï¼Œä¸è¦†ç›–ï¼Œåªéšè—æµè§ˆæŒ‰é’®
                    browseBtn.style.display = 'none';
                    return;
                }
                
                savePathSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¿å­˜ç›®å½•</option>';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(favorite => {
                        const option = document.createElement('option');
                        option.value = `${favorite.folderId || favorite.path}|${favorite.path}`;
                        option.textContent = `${favorite.name} (${favorite.path})`;
                        savePathSelect.appendChild(option);
                    });
                    browseBtn.style.display = 'none';
                } else {
                    savePathSelect.innerHTML = '<option value="">æš‚æ— å¸¸ç”¨ç›®å½•</option>';
                    browseBtn.style.display = 'inline-block';
                }
            } catch (error) {
                console.error('è·å–å¸¸ç”¨ç›®å½•å¤±è´¥:', error);
                savePathSelect.innerHTML = '<option value="">è·å–å¸¸ç”¨ç›®å½•å¤±è´¥</option>';
                browseBtn.style.display = 'inline-block';
            }
        }

        // æ˜¾ç¤ºç›®å½•æµè§ˆå™¨
        function showDirectoryBrowser() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                alert('è¯·å…ˆé€‰æ‹©è´¦å·');
                return;
            }
            
            document.getElementById('directoryBrowser').style.display = 'flex';
            currentFolderId = '-11';
            currentDirectoryPath = '/';
            directoryStack = []; // é‡ç½®ç›®å½•æ ˆ
            loadDirectoryTree();
        }

        // éšè—ç›®å½•æµè§ˆå™¨
        function hideDirectoryBrowser() {
            document.getElementById('directoryBrowser').style.display = 'none';
        }

        // åŠ è½½ç›®å½•æ ‘
        async function loadDirectoryTree() {
            const accountId = document.getElementById('account_id').value;
            const pathDisplay = document.getElementById('currentPath');
            const directoryList = document.getElementById('directoryList');
            
            pathDisplay.textContent = currentDirectoryPath;
            console.log(`åŠ è½½ç›®å½•æ ‘: accountId=${accountId}, folderId=${currentFolderId}, path=${currentDirectoryPath}`);
            
            try {
                const response = await fetch(`/api/directories/${accountId}?folderId=${currentFolderId}`);
                const data = await response.json();
                
                console.log('ç›®å½•æ ‘å“åº”:', data);
                
                if (data.success && data.data.length > 0) {
                    directoryList.innerHTML = data.data.map(item => `
                        <div class="directory-item" onclick="enterDirectory('${item.id}', '${item.name}')">
                            <span class="folder-icon">ğŸ“</span>
                            <span class="folder-name">${item.name}</span>
                        </div>
                    `).join('');
                } else {
                    directoryList.innerHTML = '<div class="no-directories">å½“å‰ç›®å½•ä¸ºç©º</div>';
                }
            } catch (error) {
                console.error('è·å–ç›®å½•å¤±è´¥:', error);
                directoryList.innerHTML = '<div class="error">è·å–ç›®å½•å¤±è´¥</div>';
            }
        }

        // è¿›å…¥ç›®å½•
        function enterDirectory(folderId, folderName) {
            // å°†å½“å‰ç›®å½•ä¿¡æ¯æ¨å…¥æ ˆä¸­
            directoryStack.push({
                id: currentFolderId,
                name: folderName,
                path: currentDirectoryPath
            });
            
            currentFolderId = folderId;
            currentDirectoryPath = currentDirectoryPath + folderName + '/';
            loadDirectoryTree();
        }

        // è¿”å›ä¸Šçº§ç›®å½•
        function goToParentDirectory() {
            if (currentDirectoryPath === '/' || directoryStack.length === 0) {
                return;
            }
            
            // ä»æ ˆä¸­å¼¹å‡ºä¸Šçº§ç›®å½•ä¿¡æ¯
            const parentDir = directoryStack.pop();
            currentFolderId = parentDir.id;
            currentDirectoryPath = parentDir.path;
            
            loadDirectoryTree();
        }

        // é€‰æ‹©å½“å‰ç›®å½•
        function selectCurrentDirectory() {
            const savePathSelect = document.getElementById('save_path');
            const option = document.createElement('option');
            
            // ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
            let displayPath = currentDirectoryPath;
            if (displayPath.endsWith('/') && displayPath !== '/') {
                displayPath = displayPath.slice(0, -1);
            }
            
            option.value = `${currentFolderId}|${currentDirectoryPath}`;
            option.textContent = `å½“å‰ç›®å½• (${displayPath})`;
            option.selected = true;
            savePathSelect.innerHTML = '';
            savePathSelect.appendChild(option);
            hideDirectoryBrowser();
        }

        // ç›‘å¬å®šæ—¶ä»»åŠ¡å¤é€‰æ¡†å˜åŒ–
        document.getElementById('enable_cron').addEventListener('change', function() {
            const cronConfig = document.getElementById('cron_config');
            cronConfig.style.display = this.checked ? 'block' : 'none';
        });

        // åˆ‡æ¢è¾“å…¥æ¨¡å¼
        function switchInputMode() {
            const singleInput = document.getElementById('single_link_input');
            const batchInput = document.getElementById('batch_link_input');
            const singleRadio = document.querySelector('input[name="input_mode"][value="single"]');
            
            if (singleRadio.checked) {
                singleInput.style.display = 'block';
                batchInput.style.display = 'none';
                // è®¾ç½®å•ä¸ªé“¾æ¥ä¸ºå¿…å¡«
                document.getElementById('share_link').required = true;
                document.getElementById('batch_links').required = false;
            } else {
                singleInput.style.display = 'none';
                batchInput.style.display = 'block';
                // è®¾ç½®æ‰¹é‡é“¾æ¥ä¸ºå¿…å¡«
                document.getElementById('share_link').required = false;
                document.getElementById('batch_links').required = true;
            }
        }

        // æ‰¹é‡è§£æé“¾æ¥
        async function parseBatchLinks() {
            const batchLinks = document.getElementById('batch_links').value.trim();
            const accountId = document.getElementById('account_id').value;
            
            if (!batchLinks) {
                showError('è¯·è¾“å…¥æ‰¹é‡åˆ†äº«é“¾æ¥');
                return;
            }
            
            if (!accountId) {
                showError('è¯·å…ˆé€‰æ‹©è´¦å·');
                return;
            }
            
            // è§£ææ‰¹é‡é“¾æ¥
            const links = batchLinks.split('\n').filter(line => line.trim());
            if (links.length === 0) {
                showError('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åˆ†äº«é“¾æ¥');
                return;
            }
            
            console.log(`å¼€å§‹æ‰¹é‡è§£æ ${links.length} ä¸ªé“¾æ¥...`);
            
            // æ˜¾ç¤ºæ‰¹é‡å¤„ç†çŠ¶æ€
            showBatchProgress(links.length);
            
            // é€ä¸ªè§£æé“¾æ¥
            const results = [];
            for (let i = 0; i < links.length; i++) {
                const line = links[i].trim();
                if (!line) continue;
                
                // è§£æé“¾æ¥å’Œè®¿é—®ç 
                const parts = line.split(/\s+/);
                const shareLink = parts[0];
                const accessCode = parts[1] || '';
                
                try {
                    const response = await fetch('/api/parse-share', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            share_link: shareLink,
                            account_id: accountId,
                            access_code: accessCode
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data.length > 0) {
                        results.push({
                            shareLink: shareLink,
                            accessCode: accessCode,
                            folders: data.data,
                            success: true
                        });
                        updateBatchProgress(i + 1, links.length, `âœ… é“¾æ¥ ${i + 1} è§£ææˆåŠŸ`);
                    } else {
                        results.push({
                            shareLink: shareLink,
                            accessCode: accessCode,
                            error: data.message || 'è§£æå¤±è´¥',
                            success: false
                        });
                        updateBatchProgress(i + 1, links.length, `âŒ é“¾æ¥ ${i + 1} è§£æå¤±è´¥: ${data.message}`);
                    }
                } catch (error) {
                    results.push({
                        shareLink: shareLink,
                        accessCode: accessCode,
                        error: error.message,
                        success: false
                    });
                    updateBatchProgress(i + 1, links.length, `âŒ é“¾æ¥ ${i + 1} è§£æå¤±è´¥: ${error.message}`);
                }
            }
            
            // æ˜¾ç¤ºæ‰¹é‡è§£æç»“æœ
            showBatchResults(results);
        }

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†è¿›åº¦
        function showBatchProgress(total) {
            const progressHtml = `
                <div id="batch_progress" class="batch-progress">
                    <div class="progress-header">
                        <h4>ğŸ”„ æ‰¹é‡è§£æè¿›åº¦</h4>
                        <span id="progress_text">0 / ${total}</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress_fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="progress_status" class="progress-status">å‡†å¤‡å¼€å§‹...</div>
                </div>
            `;
            
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.innerHTML = progressHtml;
            errorDiv.className = 'batch-progress-container';
        }

        // æ›´æ–°æ‰¹é‡å¤„ç†è¿›åº¦
        function updateBatchProgress(current, total, status) {
            const progressFill = document.getElementById('progress_fill');
            const progressText = document.getElementById('progress_text');
            const progressStatus = document.getElementById('progress_status');
            
            if (progressFill && progressText && progressStatus) {
                const percentage = (current / total) * 100;
                progressFill.style.width = percentage + '%';
                progressText.textContent = `${current} / ${total}`;
                progressStatus.textContent = status;
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡è§£æç»“æœ
        function showBatchResults(results) {
            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;
            
            let resultHtml = `
                <div class="batch-results">
                    <div class="results-summary">
                        <h4>ğŸ“Š æ‰¹é‡è§£æç»“æœ</h4>
                        <div class="results-stats">
                            <span class="stat-success">âœ… æˆåŠŸ: ${successCount}</span>
                            <span class="stat-fail">âŒ å¤±è´¥: ${failCount}</span>
                        </div>
                    </div>
            `;
            
            if (successCount > 0) {
                resultHtml += '<div class="success-links">';
                results.filter(r => r.success).forEach((result, index) => {
                    resultHtml += `
                        <div class="link-result success">
                            <div class="link-info">
                                <span class="link-number">#${index + 1}</span>
                                <span class="link-url">${result.shareLink}</span>
                                ${result.accessCode ? `<span class="access-code">è®¿é—®ç : ${result.accessCode}</span>` : ''}
                            </div>
                            <div class="folder-count">æ‰¾åˆ° ${result.folders.length} ä¸ªç›®å½•</div>
                        </div>
                    `;
                });
                resultHtml += '</div>';
            }
            
            if (failCount > 0) {
                resultHtml += '<div class="failed-links">';
                results.filter(r => !r.success).forEach((result, index) => {
                    resultHtml += `
                        <div class="link-result fail">
                            <div class="link-info">
                                <span class="link-number">#${index + 1}</span>
                                <span class="link-url">${result.shareLink}</span>
                                ${result.accessCode ? `<span class="access-code">è®¿é—®ç : ${result.accessCode}</span>` : ''}
                            </div>
                            <div class="error-message">${result.error}</div>
                        </div>
                    `;
                });
                resultHtml += '</div>';
            }
            
            resultHtml += '</div>';
            
            const errorDiv = document.getElementById('share_parse_error');
            errorDiv.innerHTML = resultHtml;
            errorDiv.className = 'batch-results-container';
        }

        // å¤„ç†è´¦å·å˜æ›´
        async function handleAccountChange() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                // æ¸…ç©ºä¿å­˜ç›®å½•é€‰æ‹©
                const savePathSelect = document.getElementById('save_path');
                const browseBtn = document.getElementById('browseDirectories');
                savePathSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©è´¦å·</option>';
                browseBtn.style.display = 'none';
                return;
            }
            
            // é¦–å…ˆå°è¯•åŠ è½½è´¦å·ç›®å½•æ˜ å°„
            await loadAccountDirectory();
            
            // ç„¶ååŠ è½½å¸¸ç”¨ç›®å½•ï¼ˆå¦‚æœæ˜ å°„å¤±è´¥ï¼‰
            await loadFavorites();
        }
        
        // åŠ è½½è´¦å·ç›®å½•æ˜ å°„
        async function loadAccountDirectory() {
            const accountId = document.getElementById('account_id').value;
            if (!accountId) {
                return;
            }
            
            try {
                const response = await fetch(`/api/account-directory/${accountId}`);
                const data = await response.json();
                
                if (data.success) {
                    // è‡ªåŠ¨è®¾ç½®ä¿å­˜ç›®å½•
                    const savePathSelect = document.getElementById('save_path');
                    const browseBtn = document.getElementById('browseDirectories');
                    const folderId = data.data.target_folder_id;
                    const folderPath = data.data.target_folder_path;
                    const folderName = data.data.folder_name;
                    
                    // åˆ›å»ºæ–°çš„é€‰é¡¹
                    const option = document.createElement('option');
                    option.value = `${folderId}|${folderPath}`;
                    option.textContent = `ğŸ¯ ${folderName} (${folderPath}) [ä¸“ç”¨æ˜ å°„]`;
                    option.selected = true;
                    option.setAttribute('data-mapping', 'true'); // æ ‡è®°ä¸ºæ˜ å°„é€‰é¡¹
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹å¹¶æ·»åŠ æ–°é€‰é¡¹
                    savePathSelect.innerHTML = '';
                    savePathSelect.appendChild(option);
                    
                    // éšè—æµè§ˆæŒ‰é’®ï¼Œå› ä¸ºå·²ç»æœ‰ä¸“ç”¨æ˜ å°„
                    browseBtn.style.display = 'none';
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`âœ… å·²è‡ªåŠ¨åº”ç”¨è´¦å· ${accountId} çš„ä¸“ç”¨ä¿å­˜ç›®å½•: ${folderName}`, 'success');
                } else {
                    // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œæ˜¾ç¤ºæç¤º
                    showMessage(`â„¹ï¸ è´¦å· ${accountId} æœªé…ç½®ä¸“ç”¨ä¿å­˜ç›®å½•ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©`, 'info');
                }
            } catch (error) {
                console.error('åŠ è½½è´¦å·ç›®å½•æ˜ å°„å¤±è´¥:', error);
                showMessage('âŒ åŠ è½½è´¦å·ç›®å½•æ˜ å°„å¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <span class="message-icon">
                    ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
                </span>
                <span class="message-text">${message}</span>
            `;
            
            // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(messageDiv, mainContent.firstChild);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // è¡¨å•æäº¤å‰éªŒè¯
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            const selectedFolders = document.querySelectorAll('input[name="selected_folders"]:checked');
            if (selectedFolders.length === 0) {
                e.preventDefault();
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ä¿å­˜çš„ç›®å½•');
                return false;
            }
            
            // éªŒè¯å®šæ—¶ä»»åŠ¡
            const enableCron = document.getElementById('enable_cron').checked;
            const cronExpression = document.getElementById('cron_expression').value.trim();
            if (enableCron && !cronExpression) {
                e.preventDefault();
                alert('å¯ç”¨å®šæ—¶ä»»åŠ¡æ—¶å¿…é¡»å¡«å†™Cronè¡¨è¾¾å¼');
                return false;
            }
        });
    </script>
</body>
</html>