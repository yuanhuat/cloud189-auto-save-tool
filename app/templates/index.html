<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç›˜è‡ªåŠ¨ä¿å­˜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>äº‘ç›˜è‡ªåŠ¨ä¿å­˜</h1>
        {% if message %}
        <div class="message {% if task_result and task_result.success %}success{% else %}error{% endif %}">
            {{ message }}
        </div>
        {% endif %}
        
        <!-- æ˜¾ç¤ºå½“å‰è®¾ç½®ä¿¡æ¯ -->
        {% if settings and (settings.project_address or settings.api_key) %}
        <div class="current-settings">
            <h3>å½“å‰è®¾ç½®</h3>
            {% if settings.project_address %}
            <p><strong>é¡¹ç›®åœ°å€:</strong> {{ settings.project_address }}</p>
            {% endif %}
            {% if settings.api_key %}
            <p><strong>API Key:</strong> {{ settings.api_key[:8] }}...</p>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- è´¦å·ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        {% if accounts %}
        <div class="accounts-section">
            <h3>è´¦å·ä¿¡æ¯</h3>
            <div class="accounts-list">
                {% for account in accounts %}
                <div class="account-item">
                    <span class="account-id">ID: {{ account.id }}</span>
                    <span class="account-username">ç”¨æˆ·å: {{ account.username }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- ä»»åŠ¡åˆ›å»ºè¡¨å• -->
        <form action="/" method="post" id="taskForm">
            <label for="share_link">åˆ†äº«é“¾æ¥:</label>
            <input type="text" id="share_link" name="share_link" placeholder="è¯·è¾“å…¥åˆ†äº«é“¾æ¥" required>
            
            {% if accounts %}
            <label for="account_id">é€‰æ‹©è´¦å·:</label>
            <select id="account_id" name="account_id" required onchange="loadFavorites()">
                <option value="">è¯·é€‰æ‹©è´¦å·</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.username }} (ID: {{ account.id }})</option>
                {% endfor %}
            </select>
            
            <label for="save_path">ä¿å­˜ç›®å½•:</label>
            <div class="directory-selection">
                <select id="save_path" name="save_path" required>
                    <option value="">è¯·å…ˆé€‰æ‹©è´¦å·</option>
                </select>
                <button type="button" id="browseDirectories" onclick="showDirectoryBrowser()" style="display: none;">
                    æµè§ˆç›®å½•
                </button>
            </div>
            
            <div class="overwrite-option">
                <label>
                    <input type="checkbox" id="overwrite_folder" name="overwrite_folder">
                    è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶å¤¹
                </label>
            </div>
            
            <!-- ç›®å½•æµè§ˆå™¨ -->
            <div id="directoryBrowser" class="directory-browser" style="display: none;">
                <div class="directory-browser-header">
                    <h4>ç›®å½•æµè§ˆå™¨</h4>
                    <button type="button" onclick="hideDirectoryBrowser()" class="close-btn">Ã—</button>
                </div>
                <div class="directory-browser-content">
                    <div class="directory-path">
                        <span>å½“å‰è·¯å¾„: </span>
                        <span id="currentPath">/</span>
                    </div>
                    <div class="directory-list" id="directoryList">
                        <!-- ç›®å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                    <div class="directory-browser-actions">
                        <button type="button" onclick="goToParentDirectory()">è¿”å›ä¸Šçº§</button>
                        <button type="button" onclick="selectCurrentDirectory()">é€‰æ‹©å½“å‰ç›®å½•</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-accounts">
                <p>æ²¡æœ‰å¯ç”¨çš„è´¦å·ï¼Œè¯·å…ˆåœ¨è®¾ç½®é¡µé¢é…ç½®APIä¿¡æ¯</p>
            </div>
            {% endif %}
            
            <button type="submit">åˆ›å»ºä»»åŠ¡</button>
        </form>
        
        <p><a href="{{ url_for('settings') }}">è®¾ç½®</a></p>
    </div>

    <script>
        let currentDirectoryPath = '/';
        let currentFolderId = '-11';
        let folderPathMap = new Map(); // å­˜å‚¨folderIdåˆ°è·¯å¾„çš„æ˜ å°„
        
        function loadFavorites() {
            const accountId = document.getElementById('account_id').value;
            const savePathSelect = document.getElementById('save_path');
            const browseBtn = document.getElementById('browseDirectories');
            
            if (!accountId) {
                savePathSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©è´¦å·</option>';
                browseBtn.style.display = 'none';
                return;
            }
            
            // æ¸…ç©ºé€‰é¡¹
            savePathSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            // è°ƒç”¨APIè·å–å¸¸ç”¨ç›®å½•
            fetch(`/api/favorites/${accountId}`)
                .then(response => response.json())
                .then(data => {
                    savePathSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¿å­˜ç›®å½•</option>';
                    
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(favorite => {
                            const option = document.createElement('option');
                            // å¸¸ç”¨ç›®å½•ä½¿ç”¨"folderId|path"æ ¼å¼
                            option.value = `${favorite.folderId || favorite.path}|${favorite.path}`;
                            option.textContent = `${favorite.name} (${favorite.path})`;
                            savePathSelect.appendChild(option);
                        });
                        browseBtn.style.display = 'none';
                    } else {
                        savePathSelect.innerHTML = '<option value="">æ²¡æœ‰å¯ç”¨çš„å¸¸ç”¨ç›®å½•</option>';
                        browseBtn.style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    console.error('è·å–å¸¸ç”¨ç›®å½•å¤±è´¥:', error);
                    savePathSelect.innerHTML = '<option value="">è·å–ç›®å½•å¤±è´¥</option>';
                    browseBtn.style.display = 'inline-block';
                });
        }
        
        function showDirectoryBrowser() {
            const browser = document.getElementById('directoryBrowser');
            browser.style.display = 'block';
            // é‡ç½®çŠ¶æ€
            currentFolderId = '-11';
            currentDirectoryPath = '/';
            folderPathMap.clear();
            folderPathMap.set('-11', '/');
            loadDirectoryTree();
        }
        
        function hideDirectoryBrowser() {
            const browser = document.getElementById('directoryBrowser');
            browser.style.display = 'none';
        }
        
        function loadDirectoryTree() {
            const accountId = document.getElementById('account_id').value;
            const directoryList = document.getElementById('directoryList');
            const currentPathSpan = document.getElementById('currentPath');
            
            currentPathSpan.textContent = currentDirectoryPath;
            directoryList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            fetch(`/api/directories/${accountId}?folderId=${encodeURIComponent(currentFolderId)}`)
                .then(response => response.json())
                .then(data => {
                    directoryList.innerHTML = '';
                    
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(item => {
                            const dirItem = document.createElement('div');
                            dirItem.className = 'directory-item';
                            dirItem.onclick = () => enterDirectory(item.id, item.name);
                            
                            const icon = document.createElement('span');
                            icon.className = 'directory-icon';
                            icon.textContent = 'ğŸ“';
                            
                            const name = document.createElement('span');
                            name.className = 'directory-name';
                            name.textContent = item.name;
                            
                            dirItem.appendChild(icon);
                            dirItem.appendChild(name);
                            directoryList.appendChild(dirItem);
                        });
                    } else {
                        directoryList.innerHTML = '<div class="no-directories">å½“å‰ç›®å½•ä¸ºç©º</div>';
                    }
                })
                .catch(error => {
                    console.error('è·å–ç›®å½•æ ‘å¤±è´¥:', error);
                    directoryList.innerHTML = '<div class="error">è·å–ç›®å½•å¤±è´¥</div>';
                });
        }
        
        function enterDirectory(folderId, folderName) {
            // æ›´æ–°è·¯å¾„
            if (currentFolderId === '-11') {
                currentDirectoryPath = '/' + folderName;
            } else {
                currentDirectoryPath = currentDirectoryPath + '/' + folderName;
            }
            
            // å­˜å‚¨è·¯å¾„æ˜ å°„
            folderPathMap.set(folderId, currentDirectoryPath);
            
            currentFolderId = folderId;
            loadDirectoryTree();
        }
        
        function goToParentDirectory() {
            if (currentFolderId === '-11') {
                return;
            }
            
            // ä»è·¯å¾„æ˜ å°„ä¸­æ‰¾åˆ°çˆ¶çº§ç›®å½•
            const pathParts = currentDirectoryPath.split('/').filter(part => part);
            pathParts.pop();
            currentDirectoryPath = '/' + pathParts.join('/');
            if (currentDirectoryPath === '') {
                currentDirectoryPath = '/';
            }
            
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…APIè¿”å›çš„æ•°æ®ç»“æ„æ¥ç¡®å®šçˆ¶çº§folderId
            // æš‚æ—¶ä½¿ç”¨-11ä½œä¸ºæ ¹ç›®å½•
            currentFolderId = '-11';
            loadDirectoryTree();
        }
        
        function selectCurrentDirectory() {
            const savePathSelect = document.getElementById('save_path');
            const currentPathSpan = document.getElementById('currentPath');
            
            // æ·»åŠ å½“å‰ç›®å½•åˆ°é€‰æ‹©åˆ—è¡¨ï¼Œä½¿ç”¨"folderId|path"æ ¼å¼
            const option = document.createElement('option');
            option.value = `${currentFolderId}|${currentDirectoryPath}`;
            option.textContent = `å½“å‰ç›®å½• (${currentDirectoryPath})`;
            option.selected = true;
            
            savePathSelect.innerHTML = '';
            savePathSelect.appendChild(option);
            
            hideDirectoryBrowser();
        }
    </script>
</body>
</html>